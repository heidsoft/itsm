{"version":3,"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-frontend/src/app/lib/http-client.ts"],"sourcesContent":["import { API_BASE_URL } from './api-config';\nimport { security } from './security';\nimport { logger } from '@/lib/env';\n\n// Request configuration interface\ninterface RequestConfig {\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\n  headers?: Record<string, string>;\n  body?: string;\n  timeout?: number;\n}\n\n// API response interface\ninterface ApiResponse<T> {\n  code: number;\n  message: string;\n  data: T;\n}\n\nclass HttpClient {\n  private baseURL: string;\n  private token: string | null = null;\n  private tenantId: number | null = null;\n  private tenantCode: string | null = null;\n  private readonly timeout: number;\n\n  constructor(baseURL: string = API_BASE_URL) {\n    this.baseURL = process.env.NEXT_PUBLIC_API_URL || baseURL;\n    this.timeout = parseInt(process.env.NEXT_PUBLIC_API_TIMEOUT || '30000');\n    // Get token and tenant ID from localStorage\n    if (typeof window !== 'undefined') {\n      this.token = localStorage.getItem('access_token'); // Changed to access_token\n      const storedTenantId = localStorage.getItem('current_tenant_id');\n      this.tenantId = storedTenantId ? parseInt(storedTenantId) : null;\n      this.tenantCode = localStorage.getItem('current_tenant_code') || null;\n    }\n  }\n\n  setToken(token: string) {\n    this.token = token;\n    if (typeof window !== 'undefined') {\n      localStorage.setItem('access_token', token); // Changed to access_token\n      // 同步更新 Cookie，有效期 15 分钟\n      document.cookie = `auth-token=${token}; path=/; max-age=900; SameSite=Lax`;\n    }\n  }\n\n  clearToken() {\n    this.token = null;\n    if (typeof window !== 'undefined') {\n      localStorage.removeItem('access_token'); // Changed to access_token\n      // 清除 Cookie\n      document.cookie = 'auth-token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n      document.cookie = 'refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n    }\n  }\n\n  setTenantId(tenantId: number | null) {\n    this.tenantId = tenantId;\n    if (typeof window !== 'undefined') {\n      if (tenantId) {\n        localStorage.setItem('current_tenant_id', tenantId.toString());\n      } else {\n        localStorage.removeItem('current_tenant_id');\n      }\n    }\n  }\n\n  setTenantCode(code: string | null) {\n    this.tenantCode = code;\n    logger.info('HttpClient.setTenantCode:', code);\n    if (typeof window !== 'undefined') {\n      if (code) {\n        localStorage.setItem('current_tenant_code', code);\n      } else {\n        localStorage.removeItem('current_tenant_code');\n      }\n    }\n  }\n\n  // Get tenant code\n  getTenantCode(): string | null {\n    return this.tenantCode;\n  }\n\n  getTenantId(): number | null {\n    return this.tenantId;\n  }\n\n  private getHeaders(): Record<string, string> {\n    // Set secure request headers\n    const csrfToken = security.csrf.getTokenFromMeta();\n    const headers: Record<string, string> = {\n      ...security.network.getSecureHeaders(csrfToken || undefined),\n    };\n\n    // Dynamically get the latest token and tenantId\n    const currentToken = typeof window !== 'undefined' ? localStorage.getItem('access_token') : this.token;\n    const currentTenantId = typeof window !== 'undefined' ? localStorage.getItem('current_tenant_id') : this.tenantId;\n\n    if (currentToken) {\n      headers['Authorization'] = `Bearer ${currentToken}`;\n    }\n\n    if (currentTenantId) {\n      headers['X-Tenant-ID'] = currentTenantId.toString();\n    }\n    const currentTenantCode = typeof window !== 'undefined' ? localStorage.getItem('current_tenant_code') : this.tenantCode;\n    if (currentTenantCode) {\n      headers['X-Tenant-Code'] = currentTenantCode;\n    }\n\n    return headers;\n  }\n\n  // Independent token refresh method to avoid circular dependencies\n  private async refreshTokenInternal(): Promise<boolean> {\n    const refreshToken = typeof window !== 'undefined' ? localStorage.getItem('refresh_token') : null;\n    if (!refreshToken) {\n      return false;\n    }\n\n    try {\n      const response = await fetch(`${this.baseURL}/api/v1/refresh-token`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          refresh_token: refreshToken,\n        }),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        if (data.code === 0) {\n          // Update access token\n          this.setToken(data.data.access_token);\n          // Also update instance variable\n          this.token = data.data.access_token;\n          return true;\n        }\n      }\n      return false;\n    } catch (error) {\n      logger.error('Token refresh failed:', error);\n      return false;\n    }\n  }\n\n  // Request method using fetch API\n  private async request<T>(endpoint: string, config: RequestConfig): Promise<T> {\n    const url = `${this.baseURL}${endpoint}`;\n    const headers = this.getHeaders();\n    const requestConfig: RequestInit = {\n      method: config.method,\n      headers: {\n        ...headers,\n        ...config.headers,\n      },\n      body: config.body,\n    };\n\n    // 仅在开发环境输出调试日志\n    if (process.env.NODE_ENV === 'development' && process.env.NEXT_PUBLIC_DEBUG_API === 'true') {\n      logger.debug('HTTP Client Request:', {\n        url,\n        method: config.method,\n        headers,\n        body: config.body\n      });\n    }\n\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), this.timeout);\n      \n      const response = await fetch(url, {\n        ...requestConfig,\n        signal: controller.signal,\n      });\n      \n      clearTimeout(timeoutId);\n      \n      // 仅在开发环境输出调试日志\n      if (process.env.NODE_ENV === 'development' && process.env.NEXT_PUBLIC_DEBUG_API === 'true') {\n        logger.debug('HTTP Client Response:', {\n          status: response.status,\n          statusText: response.statusText,\n          headers: response.headers ? Object.fromEntries(response.headers.entries()) : {}\n        });\n      }\n      \n      // If 401 error, try to refresh token\n      if (response.status === 401) {\n        const refreshSuccess = await this.refreshTokenInternal();\n        if (refreshSuccess) {\n          // Retry original request\n          const retryConfig: RequestInit = {\n            ...requestConfig,\n            headers: {\n              ...this.getHeaders(),\n              ...config.headers,\n            },\n          };\n          const retryResponse = await fetch(url, retryConfig);\n          if (!retryResponse.ok) {\n            const rid = retryResponse.headers.get('X-Request-Id') || '';\n            const suffix = rid ? ` [RID: ${rid}]` : '';\n            throw new Error(`HTTP error! status: ${retryResponse.status}${suffix}`);\n          }\n          const retryData = await retryResponse.json() as ApiResponse<T>;\n          logger.debug('HTTP Client Retry Response Data:', retryData);\n          \n          // Check response code\n          if (retryData.code !== 0) {\n            const rid = retryResponse.headers.get('X-Request-Id') || '';\n            const suffix = rid ? ` [RID: ${rid}]` : '';\n            throw new Error((retryData.message || 'Request failed') + suffix);\n          }\n          \n          return retryData.data;\n        } else {\n          // Refresh failed, clear token and redirect to login\n          this.clearToken();\n          if (typeof window !== 'undefined') {\n            localStorage.removeItem('refresh_token');\n            window.location.href = '/login';\n          }\n          throw new Error('Authentication failed');\n        }\n      }\n\n      if (!response.ok) {\n        const rid = response.headers.get('X-Request-Id') || '';\n        const suffix = rid ? ` [RID: ${rid}]` : '';\n        throw new Error(`HTTP error! status: ${response.status}${suffix}`);\n      }\n\n      const responseData = await response.json() as ApiResponse<T>;\n      // 仅在开发环境输出调试日志\n      if (process.env.NODE_ENV === 'development' && process.env.NEXT_PUBLIC_DEBUG_API === 'true') {\n        logger.debug('HTTP Client Raw Response Data:', responseData);\n        logger.debug('HTTP Client Response Code:', responseData.code);\n        logger.debug('HTTP Client Response Message:', responseData.message);\n        logger.debug('HTTP Client Response Data Type:', typeof responseData.data);\n      }\n      \n      // Check response code\n      if (responseData.code !== 0) {\n        const rid = (response.headers && response.headers.get('X-Request-Id')) || '';\n        const suffix = rid ? ` [RID: ${rid}]` : '';\n        const errorMessage = responseData.message || 'Request failed';\n        logger.error('API Error:', {\n          code: responseData.code,\n          message: errorMessage,\n          endpoint,\n          url,\n          responseData\n        });\n        throw new Error(errorMessage + suffix);\n      }\n      \n      // 验证data字段存在\n      if (responseData.data === undefined || responseData.data === null) {\n        logger.error('API Response data is undefined or null:', responseData);\n        throw new Error('API响应数据为空');\n      }\n      \n      return responseData.data;\n    } catch (error: unknown) {\n      logger.error('Request failed:', {\n        error,\n        endpoint,\n        url: `${this.baseURL}${endpoint}`,\n        method: config.method\n      });\n      \n      if (error instanceof Error) {\n        if (error.name === 'AbortError') {\n          throw new Error('Request timeout, please try again later');\n        }\n        // 如果是网络错误，提供更友好的错误信息\n        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {\n          throw new Error('无法连接到服务器，请检查网络连接或确保后端服务正在运行');\n        }\n        throw error;\n      }\n      throw new Error('Unknown error occurred');\n    }\n  }\n\n  async get<T>(endpoint: string, params?: Record<string, unknown>): Promise<T> {\n    let url = endpoint;\n    if (params) {\n      const searchParams = new URLSearchParams();\n      Object.entries(params).forEach(([key, value]) => {\n        if (value !== undefined && value !== null) {\n          searchParams.append(key, String(value));\n        }\n      });\n      url += `?${searchParams.toString()}`;\n    }\n    \n    return this.request<T>(url, {\n      method: 'GET',\n    });\n  }\n\n  async post<T>(endpoint: string, data?: unknown): Promise<T> {\n    return this.request<T>(endpoint, {\n      method: 'POST',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async put<T>(endpoint: string, data?: unknown): Promise<T> {\n    return this.request<T>(endpoint, {\n      method: 'PUT',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async patch<T>(endpoint: string, data?: unknown): Promise<T> {\n    return this.request<T>(endpoint, {\n      method: 'PATCH',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async delete<T>(endpoint: string): Promise<T> {\n    return this.request<T>(endpoint, {\n      method: 'DELETE',\n    });\n  }\n}\n\nexport const httpClient = new HttpClient();\nexport default HttpClient;\n"],"names":["httpClient","HttpClient","constructor","baseURL","API_BASE_URL","token","tenantId","tenantCode","process","env","NEXT_PUBLIC_API_URL","timeout","parseInt","NEXT_PUBLIC_API_TIMEOUT","window","localStorage","getItem","storedTenantId","setToken","setItem","document","cookie","clearToken","removeItem","setTenantId","toString","setTenantCode","code","logger","info","getTenantCode","getTenantId","getHeaders","csrfToken","security","csrf","getTokenFromMeta","headers","network","getSecureHeaders","undefined","currentToken","currentTenantId","currentTenantCode","refreshTokenInternal","refreshToken","response","fetch","method","body","JSON","stringify","refresh_token","ok","data","json","access_token","error","request","endpoint","config","url","requestConfig","NODE_ENV","NEXT_PUBLIC_DEBUG_API","debug","controller","AbortController","timeoutId","setTimeout","abort","signal","clearTimeout","status","statusText","Object","fromEntries","entries","refreshSuccess","retryConfig","retryResponse","rid","get","suffix","Error","retryData","message","location","href","responseData","errorMessage","name","includes","params","searchParams","URLSearchParams","forEach","key","value","append","String","post","put","patch","delete"],"mappings":"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"}
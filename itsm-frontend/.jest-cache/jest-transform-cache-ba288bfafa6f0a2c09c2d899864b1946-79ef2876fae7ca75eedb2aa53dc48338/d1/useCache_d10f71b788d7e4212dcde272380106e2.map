{"version":3,"names":["cacheManager","cov_bceh99nyz","f","s","useCache","CacheManager","set","key","data","ttl","b","cache","size","maxSize","firstKey","keys","next","value","undefined","delete","timestamp","Date","now","get","entry","isExpired","getStale","isStale","clear","Map","fetcher","options","staleWhileRevalidate","setData","_react","useState","loading","setLoading","error","setError","fetchData","useCallback","forceRefresh","cachedData","staleData","result","err","mutate","newData","invalidate","useEffect","refetch"],"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-frontend/src/lib/hooks/useCache.ts"],"sourcesContent":["import { useState, useEffect, useCallback } from 'react';\n\ninterface CacheOptions {\n  ttl?: number; // 缓存时间（毫秒）\n  staleWhileRevalidate?: boolean; // 返回过期数据同时重新验证\n}\n\ninterface CacheEntry<T> {\n  data: T;\n  timestamp: number;\n  ttl: number;\n}\n\nclass CacheManager {\n  private cache = new Map<string, CacheEntry<unknown>>();\n  private maxSize = 100;\n\n  set<T>(key: string, data: T, ttl: number = 5 * 60 * 1000) {\n    // 如果缓存已满，删除最旧的条目\n    if (this.cache.size >= this.maxSize) {\n      const firstKey = this.cache.keys().next().value;\n      if (firstKey !== undefined) {\n        this.cache.delete(firstKey);\n      }\n    }\n\n    this.cache.set(key, {\n      data,\n      timestamp: Date.now(),\n      ttl\n    });\n  }\n\n  get<T>(key: string): T | null {\n    const entry = this.cache.get(key);\n    if (!entry) return null;\n\n    const isExpired = Date.now() - entry.timestamp > entry.ttl;\n    if (isExpired) {\n      this.cache.delete(key);\n      return null;\n    }\n\n    return entry.data as T;\n  }\n\n  getStale<T>(key: string): T | null {\n    const entry = this.cache.get(key);\n    return entry ? (entry.data as T) : null;\n  }\n\n  isStale(key: string): boolean {\n    const entry = this.cache.get(key);\n    if (!entry) return true;\n    return Date.now() - entry.timestamp > entry.ttl;\n  }\n\n  delete(key: string) {\n    this.cache.delete(key);\n  }\n\n  clear() {\n    this.cache.clear();\n  }\n}\n\nconst cacheManager = new CacheManager();\n\nexport function useCache<T>(\n  key: string,\n  fetcher: () => Promise<T>,\n  options: CacheOptions = {}\n) {\n  const { ttl = 5 * 60 * 1000, staleWhileRevalidate = true } = options;\n  \n  const [data, setData] = useState<T | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<Error | null>(null);\n\n  const fetchData = useCallback(async (forceRefresh = false) => {\n    try {\n      setError(null);\n      \n      // 检查缓存\n      if (!forceRefresh) {\n        const cachedData = cacheManager.get<T>(key);\n        if (cachedData) {\n          setData(cachedData);\n          return cachedData;\n        }\n\n        // 如果启用了 staleWhileRevalidate，先返回过期数据\n        if (staleWhileRevalidate) {\n          const staleData = cacheManager.getStale<T>(key);\n          if (staleData) {\n            setData(staleData);\n          }\n        }\n      }\n\n      setLoading(true);\n      const result = await fetcher();\n      \n      // 缓存新数据\n      cacheManager.set(key, result, ttl);\n      setData(result);\n      \n      return result;\n    } catch (err) {\n      setError(err as Error);\n      throw err;\n    } finally {\n      setLoading(false);\n    }\n  }, [key, fetcher, ttl, staleWhileRevalidate]);\n\n  const mutate = useCallback((newData: T) => {\n    cacheManager.set(key, newData, ttl);\n    setData(newData);\n  }, [key, ttl]);\n\n  const invalidate = useCallback(() => {\n    cacheManager.delete(key);\n  }, [key]);\n\n  useEffect(() => {\n    fetchData();\n  }, [fetchData]);\n\n  return {\n    data,\n    loading,\n    error,\n    refetch: () => fetchData(true),\n    mutate,\n    invalidate\n  };\n}\n\nexport { cacheManager };\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}
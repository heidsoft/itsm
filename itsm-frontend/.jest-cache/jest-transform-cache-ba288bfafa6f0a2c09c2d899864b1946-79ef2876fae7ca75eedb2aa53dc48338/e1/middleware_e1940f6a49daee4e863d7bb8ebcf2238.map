{"version":3,"names":["config","cov_gakdarbqy","f","s","middleware","protectedRoutes","publicRoutes","apiRoutes","getAuthToken","request","cookieToken","cookies","get","value","b","authHeader","headers","startsWith","substring","customToken","accessToken","pathname","nextUrl","token","some","route","_server","NextResponse","next","isProtectedRoute","isPublicRoute","loginUrl","URL","url","searchParams","set","redirect","matcher"],"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-frontend/src/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\n\n// 需要认证的路由\nconst protectedRoutes = [\n  '/dashboard',\n  '/tickets',\n  '/incidents',\n  '/problems',\n  '/changes',\n  '/assets',\n  '/cmdb',\n  '/service-catalog',\n  '/knowledge-base',\n  '/sla',\n  '/reports',\n  '/workflow',\n  '/users',\n  '/settings',\n  '/admin',\n  '/enterprise',\n  '/projects',\n  '/applications',\n  '/tags',\n];\n\n// 公开路由（不需要认证）\nconst publicRoutes = [\n  '/login',\n  '/register',\n  '/forgot-password',\n  '/reset-password',\n];\n\n// API路由（需要特殊处理）\nconst apiRoutes = [\n  '/api',\n];\n\n/**\n * 从请求中获取认证 Token\n * 支持多种方式：Cookie、Authorization Header\n */\nfunction getAuthToken(request: NextRequest): string | null {\n  // 1. 优先从 Cookie 读取（浏览器访问）\n  const cookieToken = request.cookies.get('auth-token')?.value;\n  if (cookieToken) {\n    return cookieToken;\n  }\n\n  // 2. 从 Authorization Header 读取（API 调用）\n  const authHeader = request.headers.get('Authorization');\n  if (authHeader) {\n    // 支持 Bearer Token 格式\n    if (authHeader.startsWith('Bearer ')) {\n      return authHeader.substring(7);\n    }\n    // 支持直接传递 Token\n    return authHeader;\n  }\n\n  // 3. 从自定义 Header 读取\n  const customToken = request.headers.get('X-Auth-Token');\n  if (customToken) {\n    return customToken;\n  }\n\n  // 4. 兼容旧的 access_token cookie\n  const accessToken = request.cookies.get('access_token')?.value;\n  if (accessToken) {\n    return accessToken;\n  }\n\n  return null;\n}\n\n/**\n * Next.js 中间件\n * 处理路由保护和认证检查\n */\nexport function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n  const token = getAuthToken(request);\n\n  // 检查是否为API路由\n  if (apiRoutes.some(route => pathname.startsWith(route))) {\n    // API路由的认证检查由后端处理\n    return NextResponse.next();\n  }\n\n  // 检查是否为受保护的路由\n  const isProtectedRoute = protectedRoutes.some(route => \n    pathname.startsWith(route)\n  );\n\n  // 检查是否为公开路由\n  const isPublicRoute = publicRoutes.some(route => \n    pathname.startsWith(route)\n  );\n\n  // 如果是受保护的路由但没有token，重定向到登录页\n  if (isProtectedRoute && !token) {\n    const loginUrl = new URL('/login', request.url);\n    loginUrl.searchParams.set('redirect', pathname);\n    return NextResponse.redirect(loginUrl);\n  }\n\n  // 如果已登录用户访问公开路由，重定向到仪表盘\n  if (isPublicRoute && token) {\n    return NextResponse.redirect(new URL('/dashboard', request.url));\n  }\n\n  // 根路径重定向\n  if (pathname === '/') {\n    if (token) {\n      return NextResponse.redirect(new URL('/dashboard', request.url));\n    } else {\n      return NextResponse.redirect(new URL('/login', request.url));\n    }\n  }\n\n  return NextResponse.next();\n}\n\n// 配置中间件匹配的路径\nexport const config = {\n  matcher: [\n    /*\n     * 匹配所有路径除了:\n     * - api (API routes)\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public folder\n     */\n    '/((?!api|_next/static|_next/image|favicon.ico|public).*)',\n  ],\n};"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA6HaA,MAAM,WAAAA,CA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","ignoreList":[]}
{"version":3,"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-frontend/src/__tests__/pages/cmdb-page.test.tsx"],"sourcesContent":["/**\n * CMDB 页面测试\n */\n\nimport React from 'react';\nimport { render, screen, fireEvent, waitFor } from '@testing-library/react';\nimport '@testing-library/jest-dom';\n\nimport CIList from '@/modules/cmdb/components/CIList';\nimport CIDetail from '@/modules/cmdb/components/CIDetail';\nimport CreateCIPage from '@/app/(main)/cmdb/cis/create/page';\nimport { CMDBApi } from '@/modules/cmdb/api';\nimport type { ConfigurationItem, CIType } from '@/modules/cmdb/types';\n\nconst mockPush = jest.fn();\nconst mockBack = jest.fn();\n\njest.mock('next/navigation', () => ({\n  useRouter: () => ({\n    push: mockPush,\n    back: mockBack,\n    replace: jest.fn(),\n    prefetch: jest.fn(),\n  }),\n  useParams: () => ({ id: '1' }),\n}));\n\njest.mock('antd', () => {\n  const actual = jest.requireActual('antd');\n  const React = jest.requireActual('react');\n  const FormContext = React.createContext({\n    values: {},\n    setValues: () => {},\n  });\n\n  const Form = ({ children, onFinish }: any) => {\n    const [values, setValues] = React.useState<Record<string, unknown>>({});\n    const handleSubmit = (event: React.FormEvent) => {\n      event.preventDefault();\n      onFinish?.(values);\n    };\n\n    return (\n      <form onSubmit={handleSubmit}>\n        <FormContext.Provider value={{ values, setValues }}>\n          {children}\n        </FormContext.Provider>\n      </form>\n    );\n  };\n\n  Form.Item = ({ label, name, children }: any) => {\n    const context = React.useContext(FormContext);\n    if (!React.isValidElement(children)) {\n      return (\n        <label>\n          {label}\n          {children}\n        </label>\n      );\n    }\n\n    const handleChange = (event: any) => {\n      const value = event?.target?.value ?? event;\n      context.setValues((prev: Record<string, unknown>) => ({\n        ...prev,\n        [name]: value,\n      }));\n      children.props.onChange?.(event);\n    };\n\n    return (\n      <label>\n        {label}\n        {React.cloneElement(children, {\n          'aria-label': label,\n          name,\n          value: context.values[name] ?? '',\n          onChange: handleChange,\n        })}\n      </label>\n    );\n  };\n\n  Form.useForm = () => [\n    {\n      getFieldsValue: () => ({}),\n      resetFields: jest.fn(),\n      setFieldsValue: jest.fn(),\n    },\n  ];\n\n  const Input = (props: any) => <input {...props} />;\n  Input.TextArea = (props: any) => <textarea {...props} />;\n\n  const Select = ({ children, onChange, value, ...rest }: any) => (\n    <select\n      {...rest}\n      value={value ?? ''}\n      onChange={(event) => onChange?.(event.target.value)}\n    >\n      {children}\n    </select>\n  );\n  Select.Option = ({ value, children }: any) => <option value={value}>{children}</option>;\n\n  const Button = ({ children, onClick, htmlType }: any) => (\n    <button type={htmlType === 'submit' ? 'submit' : 'button'} onClick={onClick}>\n      {children}\n    </button>\n  );\n\n  const Table = ({ dataSource = [], columns = [] }: any) => (\n    <div>\n      {dataSource.map((record: any, rowIndex: number) => (\n        <div key={record.id ?? rowIndex}>\n          {columns.map((column: any, colIndex: number) => {\n            const value = record[column.dataIndex];\n            const content = column.render ? column.render(value, record) : value;\n            return <div key={column.key ?? column.dataIndex ?? colIndex}>{content}</div>;\n          })}\n        </div>\n      ))}\n    </div>\n  );\n\n  const Tabs = ({ children }: any) => <div>{children}</div>;\n  Tabs.TabPane = ({ children }: any) => <div>{children}</div>;\n\n  const Descriptions = ({ children }: any) => <div>{children}</div>;\n  Descriptions.Item = ({ label, children }: any) => (\n    <div>\n      <span>{label}</span>\n      {children}\n    </div>\n  );\n\n  const Card = ({ children }: any) => <div>{children}</div>;\n  const Space = ({ children }: any) => <div>{children}</div>;\n  const Breadcrumb = ({ items = [] }: any) => (\n    <nav>\n      {items.map((item: any, index: number) => (\n        <span key={index}>{item.title}</span>\n      ))}\n    </nav>\n  );\n  const Tag = ({ children }: any) => <span>{children}</span>;\n  const Skeleton = ({ children }: any) => <div>{children}</div>;\n  const Result = ({ title, subTitle, extra }: any) => (\n    <div>\n      <div>{title}</div>\n      <div>{subTitle}</div>\n      {extra}\n    </div>\n  );\n  const Empty = ({ description }: any) => <div>{description}</div>;\n  const Tooltip = ({ children }: any) => <span>{children}</span>;\n\n  return {\n    ...actual,\n    Button,\n    Card,\n    Breadcrumb,\n    Descriptions,\n    Empty,\n    Form,\n    Input,\n    Modal: {\n      ...actual.Modal,\n      confirm: jest.fn(),\n    },\n    Select,\n    Skeleton,\n    Space,\n    Table,\n    Tabs,\n    Tag,\n    Tooltip,\n    Result,\n    message: {\n      success: jest.fn(),\n      error: jest.fn(),\n      warning: jest.fn(),\n      info: jest.fn(),\n    },\n  };\n});\n\njest.mock('@/modules/cmdb/api', () => ({\n  CMDBApi: {\n    getCIs: jest.fn(),\n    getCI: jest.fn(),\n    getTypes: jest.fn(),\n    createCI: jest.fn(),\n    deleteCI: jest.fn(),\n  },\n}));\n\nconst mockTypes: CIType[] = [\n  {\n    id: 1,\n    name: '服务器',\n    description: '',\n    is_active: true,\n    tenant_id: 1,\n  },\n];\n\nconst mockItem: ConfigurationItem = {\n  id: 1,\n  name: '应用服务器-01',\n  description: '测试资产',\n  type: 'server',\n  status: 'active',\n  ci_type_id: 1,\n  tenant_id: 1,\n  created_at: '2024-01-01T00:00:00Z',\n  updated_at: '2024-01-01T00:00:00Z',\n};\n\ndescribe('CMDB 页面', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (CMDBApi.getTypes as jest.Mock).mockResolvedValue(mockTypes);\n    (CMDBApi.getCIs as jest.Mock).mockResolvedValue({\n      items: [mockItem],\n      total: 1,\n      page: 1,\n      size: 10,\n    });\n    (CMDBApi.getCI as jest.Mock).mockResolvedValue(mockItem);\n    (CMDBApi.createCI as jest.Mock).mockResolvedValue(mockItem);\n    (CMDBApi.deleteCI as jest.Mock).mockResolvedValue(undefined);\n  });\n\n  it('CI 列表应展示资产并支持跳转', async () => {\n    render(<CIList />);\n\n    await waitFor(() => {\n      expect(screen.getByText('应用服务器-01')).toBeInTheDocument();\n    });\n\n    fireEvent.click(screen.getByRole('button', { name: '应用服务器-01' }));\n    expect(mockPush).toHaveBeenCalledWith('/cmdb/cis/1');\n  });\n\n  it('CI 详情应展示资产信息', async () => {\n    render(<CIDetail />);\n\n    await waitFor(() => {\n      expect(screen.getByText('应用服务器-01')).toBeInTheDocument();\n    });\n    expect(screen.getByText(/配置项 ID: 1/)).toBeInTheDocument();\n  });\n\n  it('创建 CI 表单应提交并返回列表', async () => {\n    render(<CreateCIPage />);\n\n    await waitFor(() => {\n      expect(CMDBApi.getTypes).toHaveBeenCalled();\n    });\n\n    fireEvent.change(screen.getByLabelText('资产名称'), {\n      target: { value: '新资产' },\n    });\n\n    fireEvent.change(screen.getByLabelText('资产类型'), {\n      target: { value: '1' },\n    });\n\n    fireEvent.change(screen.getByLabelText('状态'), {\n      target: { value: 'active' },\n    });\n\n    fireEvent.click(screen.getByRole('button', { name: '保存' }));\n\n    await waitFor(() => {\n      expect(CMDBApi.createCI).toHaveBeenCalled();\n    });\n    expect(mockPush).toHaveBeenCalledWith('/cmdb');\n  });\n});\n"],"names":["jest","mock","useRouter","push","mockPush","back","mockBack","replace","fn","prefetch","useParams","id","actual","requireActual","React","FormContext","createContext","values","setValues","Form","children","onFinish","useState","handleSubmit","event","preventDefault","form","onSubmit","Provider","value","Item","label","name","context","useContext","isValidElement","handleChange","target","prev","props","onChange","cloneElement","useForm","getFieldsValue","resetFields","setFieldsValue","Input","input","TextArea","textarea","Select","rest","select","Option","option","Button","onClick","htmlType","button","type","Table","dataSource","columns","div","map","record","rowIndex","column","colIndex","dataIndex","content","render","key","Tabs","TabPane","Descriptions","span","Card","Space","Breadcrumb","items","nav","item","index","title","Tag","Skeleton","Result","subTitle","extra","Empty","description","Tooltip","Modal","confirm","message","success","error","warning","info","CMDBApi","getCIs","getCI","getTypes","createCI","deleteCI","mockTypes","is_active","tenant_id","mockItem","status","ci_type_id","created_at","updated_at","describe","beforeEach","clearAllMocks","mockResolvedValue","total","page","size","undefined","it","CIList","waitFor","expect","screen","getByText","toBeInTheDocument","fireEvent","click","getByRole","toHaveBeenCalledWith","CIDetail","CreateCIPage","toHaveBeenCalled","change","getByLabelText"],"mappings":"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"}
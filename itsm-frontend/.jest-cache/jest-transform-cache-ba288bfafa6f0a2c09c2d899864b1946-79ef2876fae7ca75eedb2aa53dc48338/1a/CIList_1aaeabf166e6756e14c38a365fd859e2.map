{"version":3,"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-frontend/src/modules/cmdb/components/CIList.tsx"],"sourcesContent":["'use client';\n\n/**\n * 配置项 (CI) 列表组件\n */\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport {\n    Table, Tag, Button, Card, Space, Tooltip,\n    Input, Select, Form, message, Modal, Breadcrumb\n} from 'antd';\nimport {\n    SearchOutlined, EyeOutlined, EditOutlined,\n    PlusOutlined, ReloadOutlined, DeleteOutlined\n} from '@ant-design/icons';\nimport { useRouter } from 'next/navigation';\nimport dayjs from 'dayjs';\n\nimport { CMDBApi } from '../api';\nimport { CIStatus, CIStatusLabels } from '../constants';\nimport type { ConfigurationItem, CIType, CIQuery } from '../types';\n\nconst { Option } = Select;\n\nconst statusColors: Record<string, string> = {\n    [CIStatus.ACTIVE]: 'green',\n    [CIStatus.INACTIVE]: 'default',\n    [CIStatus.MAINTENANCE]: 'orange',\n    [CIStatus.DECOMMISSIONED]: 'red',\n};\n\nconst CIList: React.FC = () => {\n    const router = useRouter();\n    const [loading, setLoading] = useState(false);\n    const [data, setData] = useState<ConfigurationItem[]>([]);\n    const [total, setTotal] = useState(0);\n    const [types, setTypes] = useState<CIType[]>([]);\n    const [form] = Form.useForm();\n    const requestIdRef = useRef(0);\n    const isMountedRef = useRef(true);\n\n    const [query, setQuery] = useState<CIQuery>({\n        page: 1,\n        page_size: 10,\n    });\n\n    const loadTypes = async () => {\n        try {\n            const res = await CMDBApi.getTypes();\n            if (!isMountedRef.current) return;\n            setTypes(res || []);\n        } catch (e) {\n            if (!isMountedRef.current) return;\n            console.error(e);\n            message.error('加载资产类型失败');\n        }\n    };\n\n    const loadData = async () => {\n        const requestId = ++requestIdRef.current;\n        setLoading(true);\n        try {\n            const values = form.getFieldsValue();\n            const resp = await CMDBApi.getCIs({\n                ...query,\n                ...values,\n            });\n            if (!isMountedRef.current || requestId !== requestIdRef.current) return;\n            setData(resp.items || []);\n            setTotal(resp.total || 0);\n        } catch (error) {\n            if (!isMountedRef.current || requestId !== requestIdRef.current) return;\n            console.error(error);\n            const errorMessage =\n                error instanceof Error\n                    ? error.message\n                    : typeof error === 'string'\n                        ? error\n                        : JSON.stringify(error);\n            message.error(errorMessage ? `加载配置项列表失败：${errorMessage}` : '加载配置项列表失败');\n        } finally {\n            if (isMountedRef.current && requestId === requestIdRef.current) {\n                setLoading(false);\n            }\n        }\n    };\n\n    useEffect(() => {\n        return () => {\n            isMountedRef.current = false;\n        };\n    }, []);\n\n    useEffect(() => {\n        loadTypes();\n    }, []);\n\n    useEffect(() => {\n        loadData();\n    }, [query]);\n\n    const handleSearch = () => {\n        setQuery(prev => ({ ...prev, page: 1 }));\n    };\n\n    const handleDelete = (id: number) => {\n        Modal.confirm({\n            title: '重申此操作',\n            content: '确定要删除此配置项吗？相关关系也将受到影响。',\n            onOk: async () => {\n                try {\n                    await CMDBApi.deleteCI(id);\n                    message.success('删除成功');\n                    loadData();\n                } catch (e) {\n                    message.error('删除失败');\n                }\n            }\n        });\n    };\n\n    const columns = [\n        {\n            title: 'ID',\n            dataIndex: 'id',\n            width: 70,\n        },\n        {\n            title: '资产名称',\n            dataIndex: 'name',\n            ellipsis: true,\n            render: (text: string, record: ConfigurationItem) => (\n                <Button\n                    type=\"link\"\n                    onClick={() => router.push(`/cmdb/cis/${record.id}`)}\n                    style={{ padding: 0, height: 'auto' }}\n                >\n                    {text}\n                </Button>\n            )\n        },\n        {\n            title: '类型',\n            dataIndex: 'ci_type_id',\n            width: 120,\n            render: (id: number) => types.find(t => t.id === id)?.name || `类型 ${id}`,\n        },\n        {\n            title: '云厂商',\n            dataIndex: 'cloud_provider',\n            width: 120,\n            render: (value?: string) => value || '-',\n        },\n        {\n            title: '状态',\n            dataIndex: 'status',\n            width: 100,\n            render: (status: CIStatus) => (\n                <Tag color={statusColors[status]}>\n                    {CIStatusLabels[status] || status}\n                </Tag>\n            ),\n        },\n        {\n            title: '型号/厂商',\n            key: 'model_vendor',\n            width: 180,\n            render: (_: any, record: ConfigurationItem) => (\n                <span>{record.model || '-'} / {record.vendor || '-'}</span>\n            )\n        },\n        {\n            title: '最后更新',\n            dataIndex: 'updated_at',\n            width: 160,\n            render: (date: string) => dayjs(date).format('YYYY-MM-DD HH:mm'),\n        },\n        {\n            title: '操作',\n            key: 'action',\n            width: 120,\n            render: (_: any, record: ConfigurationItem) => (\n                <Space size=\"small\">\n                    <Tooltip title=\"编辑\">\n                        <Button\n                            type=\"text\"\n                            icon={<EditOutlined />}\n                            aria-label=\"编辑\"\n                            onClick={() => router.push(`/cmdb/cis/${record.id}/edit`)}\n                        />\n                    </Tooltip>\n                    <Tooltip title=\"删除\">\n                        <Button\n                            type=\"text\"\n                            danger\n                            icon={<DeleteOutlined />}\n                            aria-label=\"删除\"\n                            onClick={() => handleDelete(record.id)}\n                        />\n                    </Tooltip>\n                </Space>\n            ),\n        },\n    ];\n\n    return (\n        <Card variant=\"borderless\">\n            <Breadcrumb\n                style={{ marginBottom: 16 }}\n                items={[\n                    { title: '首页' },\n                    { title: '配置管理' },\n                    { title: '配置项列表' },\n                ]}\n            />\n\n            <Form form={form} layout=\"inline\" style={{ marginBottom: 24 }}>\n                <Form.Item name=\"search\">\n                    <Input placeholder=\"搜索名称/序列号\" allowClear prefix={<SearchOutlined />} />\n                </Form.Item>\n                <Form.Item name=\"ci_type_id\">\n                    <Select placeholder=\"资产类型\" style={{ width: 140 }} allowClear>\n                        {types.map(t => (\n                            <Option key={t.id} value={t.id}>{t.name}</Option>\n                        ))}\n                    </Select>\n                </Form.Item>\n                <Form.Item name=\"status\">\n                    <Select placeholder=\"状态\" style={{ width: 110 }} allowClear>\n                        {Object.entries(CIStatusLabels).map(([value, label]) => (\n                            <Option key={value} value={value}>{label}</Option>\n                        ))}\n                    </Select>\n                </Form.Item>\n                <Form.Item>\n                    <Space>\n                        <Button type=\"primary\" onClick={handleSearch}>查询</Button>\n                        <Button icon={<ReloadOutlined />} onClick={loadData} aria-label=\"刷新\" />\n                        <Button onClick={() => router.push('/cmdb/cloud-services')}>云服务目录</Button>\n                        <Button onClick={() => router.push('/cmdb/cloud-accounts')}>云账号管理</Button>\n                    </Space>\n                </Form.Item>\n                <div style={{ flex: 1, textAlign: 'right' }}>\n                    <Button\n                        type=\"primary\"\n                        icon={<PlusOutlined />}\n                        onClick={() => router.push('/cmdb/cis/create')}\n                    >\n                        录入资产\n                    </Button>\n                </div>\n            </Form>\n\n            <Table\n                rowKey=\"id\"\n                columns={columns as any}\n                dataSource={data}\n                loading={loading}\n                pagination={{\n                    current: query.page,\n                    pageSize: query.page_size,\n                    total: total,\n                    onChange: (page, page_size) => setQuery(prev => ({ ...prev, page, page_size })),\n                }}\n            />\n        </Card>\n    );\n};\n\nexport default CIList;\n"],"names":["Option","Select","statusColors","CIStatus","ACTIVE","INACTIVE","MAINTENANCE","DECOMMISSIONED","CIList","router","useRouter","loading","setLoading","useState","data","setData","total","setTotal","types","setTypes","form","Form","useForm","requestIdRef","useRef","isMountedRef","query","setQuery","page","page_size","loadTypes","res","CMDBApi","getTypes","current","e","console","error","message","loadData","requestId","values","getFieldsValue","resp","getCIs","items","errorMessage","Error","JSON","stringify","useEffect","handleSearch","prev","handleDelete","id","Modal","confirm","title","content","onOk","deleteCI","success","columns","dataIndex","width","ellipsis","render","text","record","Button","type","onClick","push","style","padding","height","find","t","name","value","status","Tag","color","CIStatusLabels","key","_","span","model","vendor","date","dayjs","format","Space","size","Tooltip","icon","EditOutlined","aria-label","danger","DeleteOutlined","Card","variant","Breadcrumb","marginBottom","layout","Item","Input","placeholder","allowClear","prefix","SearchOutlined","map","Object","entries","label","ReloadOutlined","div","flex","textAlign","PlusOutlined","Table","rowKey","dataSource","pagination","pageSize","onChange"],"mappings":"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"}
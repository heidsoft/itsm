{"version":3,"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-frontend/src/__tests__/pages/cmdb-page.test.tsx"],"sourcesContent":["/**\n * CMDB 页面测试\n */\n\nimport React from 'react';\nimport { render, screen, fireEvent, waitFor } from '@testing-library/react';\nimport '@testing-library/jest-dom';\n\nimport CIList from '@/modules/cmdb/components/CIList';\nimport CIDetail from '@/modules/cmdb/components/CIDetail';\nimport CreateCIPage from '@/app/(main)/cmdb/cis/create/page';\nimport { CMDBApi } from '@/modules/cmdb/api';\nimport type { ConfigurationItem, CIType } from '@/modules/cmdb/types';\n\nconst mockPush = jest.fn();\nconst mockBack = jest.fn();\n\njest.mock('next/navigation', () => ({\n  useRouter: () => ({\n    push: mockPush,\n    back: mockBack,\n    replace: jest.fn(),\n    prefetch: jest.fn(),\n  }),\n  useParams: () => ({ id: '1' }),\n}));\n\njest.mock('antd', () => {\n  const actual = jest.requireActual('antd');\n  return {\n    ...actual,\n    message: {\n      success: jest.fn(),\n      error: jest.fn(),\n      warning: jest.fn(),\n      info: jest.fn(),\n    },\n    Modal: {\n      ...actual.Modal,\n      confirm: jest.fn(),\n    },\n  };\n});\n\njest.mock('@/modules/cmdb/api', () => ({\n  CMDBApi: {\n    getCIs: jest.fn(),\n    getCI: jest.fn(),\n    getTypes: jest.fn(),\n    createCI: jest.fn(),\n    deleteCI: jest.fn(),\n  },\n}));\n\nconst mockTypes: CIType[] = [\n  {\n    id: 1,\n    name: '服务器',\n    description: '',\n    is_active: true,\n    tenant_id: 1,\n  },\n];\n\nconst mockItem: ConfigurationItem = {\n  id: 1,\n  name: '应用服务器-01',\n  description: '测试资产',\n  type: 'server',\n  status: 'active',\n  ci_type_id: 1,\n  tenant_id: 1,\n  created_at: '2024-01-01T00:00:00Z',\n  updated_at: '2024-01-01T00:00:00Z',\n};\n\ndescribe('CMDB 页面', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (CMDBApi.getTypes as jest.Mock).mockResolvedValue(mockTypes);\n    (CMDBApi.getCIs as jest.Mock).mockResolvedValue({\n      items: [mockItem],\n      total: 1,\n      page: 1,\n      size: 10,\n    });\n    (CMDBApi.getCI as jest.Mock).mockResolvedValue(mockItem);\n    (CMDBApi.createCI as jest.Mock).mockResolvedValue(mockItem);\n    (CMDBApi.deleteCI as jest.Mock).mockResolvedValue(undefined);\n  });\n\n  it('CI 列表应展示资产并支持跳转', async () => {\n    render(<CIList />);\n\n    await waitFor(() => {\n      expect(screen.getByText('应用服务器-01')).toBeInTheDocument();\n    });\n\n    fireEvent.click(screen.getByRole('button', { name: '应用服务器-01' }));\n    expect(mockPush).toHaveBeenCalledWith('/cmdb/cis/1');\n  });\n\n  it('CI 详情应展示资产信息', async () => {\n    render(<CIDetail />);\n\n    await waitFor(() => {\n      expect(screen.getByText('应用服务器-01')).toBeInTheDocument();\n    });\n    expect(screen.getByText(/配置项 ID: 1/)).toBeInTheDocument();\n  });\n\n  it('创建 CI 表单应提交并返回列表', async () => {\n    render(<CreateCIPage />);\n\n    await waitFor(() => {\n      expect(CMDBApi.getTypes).toHaveBeenCalled();\n    });\n\n    fireEvent.change(screen.getByLabelText('资产名称'), {\n      target: { value: '新资产' },\n    });\n\n    fireEvent.mouseDown(screen.getByLabelText('资产类型'));\n    fireEvent.click(screen.getByText('服务器'));\n\n    fireEvent.mouseDown(screen.getByLabelText('状态'));\n    fireEvent.click(screen.getByText('使用中'));\n\n    fireEvent.click(screen.getByRole('button', { name: '保存' }));\n\n    await waitFor(() => {\n      expect(CMDBApi.createCI).toHaveBeenCalled();\n    });\n    expect(mockPush).toHaveBeenCalledWith('/cmdb');\n  });\n});\n"],"names":["jest","mock","useRouter","push","mockPush","back","mockBack","replace","fn","prefetch","useParams","id","actual","requireActual","message","success","error","warning","info","Modal","confirm","CMDBApi","getCIs","getCI","getTypes","createCI","deleteCI","mockTypes","name","description","is_active","tenant_id","mockItem","type","status","ci_type_id","created_at","updated_at","describe","beforeEach","clearAllMocks","mockResolvedValue","items","total","page","size","undefined","it","render","CIList","waitFor","expect","screen","getByText","toBeInTheDocument","fireEvent","click","getByRole","toHaveBeenCalledWith","CIDetail","CreateCIPage","toHaveBeenCalled","change","getByLabelText","target","value","mouseDown"],"mappings":"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"}
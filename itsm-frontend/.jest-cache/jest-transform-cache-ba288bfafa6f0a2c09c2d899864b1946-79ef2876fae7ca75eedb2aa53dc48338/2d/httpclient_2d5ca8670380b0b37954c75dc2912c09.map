{"version":3,"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-frontend/src/lib/api/http-client.ts"],"sourcesContent":["import { API_BASE_URL } from '@/app/lib/api-config';\nimport { security } from '@/lib/security';\nimport { logger } from '@/lib/env';\n\n// Request configuration interface\nexport interface RequestConfig {\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\n  headers?: Record<string, string>;\n  body?: BodyInit | null;\n  timeout?: number;\n}\n\n// Axios-like request config used by some legacy API modules\nexport interface AxiosLikeRequestConfig {\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\n  url: string;\n  params?: object;\n  data?: unknown;\n  headers?: Record<string, string>;\n  responseType?: 'json' | 'blob';\n}\n\n// API response interface\ninterface ApiResponse<T> {\n  code: number;\n  message: string;\n  data: T;\n}\n\nclass HttpClient {\n  private baseURL: string;\n  private token: string | null = null;\n  private tenantId: number | null = null;\n  private tenantCode: string | null = null;\n  private readonly timeout: number;\n\n  constructor(baseURL: string = API_BASE_URL) {\n    this.baseURL = process.env.NEXT_PUBLIC_API_URL || baseURL;\n    this.timeout = parseInt(process.env.NEXT_PUBLIC_API_TIMEOUT || '30000');\n    // Get token and tenant ID from localStorage\n    if (typeof window !== 'undefined') {\n      this.token = localStorage.getItem('access_token'); // Changed to access_token\n      const storedTenantId = localStorage.getItem('current_tenant_id');\n      this.tenantId = storedTenantId ? parseInt(storedTenantId) : null;\n      this.tenantCode = localStorage.getItem('current_tenant_code') || null;\n    }\n  }\n\n  setToken(token: string) {\n    this.token = token;\n    if (typeof window !== 'undefined') {\n      localStorage.setItem('access_token', token); // Changed to access_token\n      // 同步更新 Cookie，有效期 15 分钟\n      document.cookie = `auth-token=${token}; path=/; max-age=900; SameSite=Lax`;\n    }\n  }\n\n  clearToken() {\n    this.token = null;\n    if (typeof window !== 'undefined') {\n      localStorage.removeItem('access_token'); // Changed to access_token\n      // 清除 Cookie\n      document.cookie = 'auth-token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n      document.cookie = 'refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n    }\n  }\n\n  setTenantId(tenantId: number | null) {\n    this.tenantId = tenantId;\n    if (typeof window !== 'undefined') {\n      if (tenantId) {\n        localStorage.setItem('current_tenant_id', tenantId.toString());\n      } else {\n        localStorage.removeItem('current_tenant_id');\n      }\n    }\n  }\n\n  setTenantCode(code: string | null) {\n    this.tenantCode = code;\n    logger.info('HttpClient.setTenantCode:', code);\n    if (typeof window !== 'undefined') {\n      if (code) {\n        localStorage.setItem('current_tenant_code', code);\n      } else {\n        localStorage.removeItem('current_tenant_code');\n      }\n    }\n  }\n\n  // Get tenant code\n  getTenantCode(): string | null {\n    return this.tenantCode;\n  }\n\n  getTenantId(): number | null {\n    return this.tenantId;\n  }\n\n  getAuthToken(): string | null {\n    return this.token;\n  }\n\n  // Backward-compat helpers (some legacy code expects these)\n  getToken(): string | null {\n    return this.getAuthToken();\n  }\n\n  getBaseURL(): string {\n    return this.baseURL;\n  }\n\n  private getHeaders(): Record<string, string> {\n    // Set secure request headers\n    const csrfToken = security.csrf.getTokenFromMeta();\n    const headers: Record<string, string> = {\n      ...security.network.getSecureHeaders(csrfToken || undefined),\n    };\n\n    // Dynamically get the latest token and tenantId\n    const currentToken = typeof window !== 'undefined' ? localStorage.getItem('access_token') : this.token;\n    const currentTenantId = typeof window !== 'undefined' ? localStorage.getItem('current_tenant_id') : this.tenantId;\n\n    if (currentToken) {\n      headers['Authorization'] = `Bearer ${currentToken}`;\n    }\n\n    if (currentTenantId) {\n      headers['X-Tenant-ID'] = currentTenantId.toString();\n    }\n    const currentTenantCode = typeof window !== 'undefined' ? localStorage.getItem('current_tenant_code') : this.tenantCode;\n    if (currentTenantCode) {\n      headers['X-Tenant-Code'] = currentTenantCode;\n    }\n\n    return headers;\n  }\n\n  // Independent token refresh method to avoid circular dependencies\n  private async refreshTokenInternal(): Promise<boolean> {\n    const refreshToken = typeof window !== 'undefined' ? localStorage.getItem('refresh_token') : null;\n    if (!refreshToken) {\n      return false;\n    }\n\n    try {\n      const response = await fetch(`${this.baseURL}/api/v1/refresh-token`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          refresh_token: refreshToken,\n        }),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        if (data.code === 0) {\n          // Update access token\n          this.setToken(data.data.access_token);\n          // Also update instance variable\n          this.token = data.data.access_token;\n          return true;\n        }\n      }\n      return false;\n    } catch (error) {\n      logger.error('Token refresh failed:', error);\n      return false;\n    }\n  }\n\n  // Core request method using fetch API (internal)\n  private async requestInternal<T>(endpoint: string, config: RequestConfig): Promise<T> {\n    const url = `${this.baseURL}${endpoint}`;\n    const headers = this.getHeaders();\n    const requestConfig: RequestInit = {\n      method: config.method,\n      headers: {\n        ...headers,\n        ...config.headers,\n      },\n      body: config.body,\n    };\n\n    logger.debug('HTTP Client Request:', {\n      url,\n      method: config.method,\n      headers,\n      body: config.body\n    });\n\n    // 在开发模式下，如果后端服务不可用，使用模拟数据\n    if (process.env.NODE_ENV === 'development' && this.baseURL.includes('localhost')) {\n      logger.warn('开发模式：正在连接到后端服务，如果后端服务未运行，将显示错误');\n    }\n\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), this.timeout);\n      \n      const response = await fetch(url, {\n        ...requestConfig,\n        signal: controller.signal,\n      });\n      \n      clearTimeout(timeoutId);\n      \n      logger.debug('HTTP Client Response:', {\n        status: response.status,\n        statusText: response.statusText,\n        headers: response.headers ? Object.fromEntries(response.headers.entries()) : {}\n      });\n      \n      // If 401 error, try to refresh token\n      if (response.status === 401) {\n        const refreshSuccess = await this.refreshTokenInternal();\n        if (refreshSuccess) {\n          // Retry original request\n          const retryConfig: RequestInit = {\n            ...requestConfig,\n            headers: {\n              ...this.getHeaders(),\n              ...config.headers,\n            },\n          };\n          const retryResponse = await fetch(url, retryConfig);\n          if (!retryResponse.ok) {\n            const rid = retryResponse.headers.get('X-Request-Id') || '';\n            const suffix = rid ? ` [RID: ${rid}]` : '';\n            throw new Error(`HTTP error! status: ${retryResponse.status}${suffix}`);\n          }\n          const retryData = await retryResponse.json() as ApiResponse<T>;\n          logger.debug('HTTP Client Retry Response Data:', retryData);\n          \n          // Check response code\n          if (retryData.code !== 0) {\n            const rid = retryResponse.headers.get('X-Request-Id') || '';\n            const suffix = rid ? ` [RID: ${rid}]` : '';\n            throw new Error((retryData.message || 'Request failed') + suffix);\n          }\n          \n          return retryData.data;\n        } else {\n          // Refresh failed, clear token and redirect to login\n          this.clearToken();\n          if (typeof window !== 'undefined') {\n            localStorage.removeItem('refresh_token');\n            window.location.href = '/login';\n          }\n          throw new Error('Authentication failed');\n        }\n      }\n\n      if (!response.ok) {\n        const rid = response.headers.get('X-Request-Id') || '';\n        const suffix = rid ? ` [RID: ${rid}]` : '';\n        throw new Error(`HTTP error! status: ${response.status}${suffix}`);\n      }\n\n      const responseData = await response.json() as ApiResponse<T>;\n      logger.debug('HTTP Client Raw Response Data:', responseData);\n      \n      // Check response code\n      if (responseData.code !== 0) {\n        const rid = (response.headers && response.headers.get('X-Request-Id')) || '';\n        const suffix = rid ? ` [RID: ${rid}]` : '';\n        throw new Error((responseData.message || 'Request failed') + suffix);\n      }\n      \n      return responseData.data;\n    } catch (error: unknown) {\n      logger.error('Request failed:', error);\n      if (error instanceof Error) {\n        if (error.name === 'AbortError') {\n          throw new Error('请求超时，请稍后重试');\n        }\n        if (error.message.includes('fetch')) {\n          throw new Error('无法连接到服务器，请检查网络连接和后端服务是否运行');\n        }\n        throw error;\n      }\n      throw new Error('未知错误发生');\n    }\n  }\n\n  /**\n   * Unified request method.\n   * Supports:\n   * - request('/path', { method, headers, body })\n   * - request({ method, url, data, headers, responseType })\n   */\n  async request<T = any>(endpoint: string, config?: Partial<RequestConfig>): Promise<T>;\n  async request<T = any>(config: AxiosLikeRequestConfig): Promise<T>;\n  async request<T = any>(\n    arg1: string | AxiosLikeRequestConfig,\n    arg2?: Partial<RequestConfig>\n  ): Promise<T> {\n    // Axios-like style: request({ url, method, data, headers, responseType })\n    if (typeof arg1 === 'object' && arg1 && 'url' in arg1) {\n      const cfg = arg1 as AxiosLikeRequestConfig;\n      const method = cfg.method || 'GET';\n      let endpoint = cfg.url;\n      if (cfg.params) {\n        const qs = new URLSearchParams();\n        Object.entries(cfg.params as Record<string, unknown>).forEach(([k, v]) => {\n          if (v !== undefined && v !== null) qs.append(k, String(v));\n        });\n        const q = qs.toString();\n        if (q) endpoint += (endpoint.includes('?') ? '&' : '?') + q;\n      }\n\n      let body: BodyInit | null | undefined = undefined;\n      if (cfg.data !== undefined) {\n        if (cfg.data instanceof FormData) body = cfg.data;\n        else body = JSON.stringify(cfg.data);\n      }\n\n      const data =\n        cfg.responseType === 'blob'\n          ? // blob passthrough\n            await (async () => {\n              const url = `${this.baseURL}${endpoint}`;\n              const headers = { ...this.getHeaders(), ...(cfg.headers || {}) };\n              if (body instanceof FormData) delete (headers as any)['Content-Type'];\n              else headers['Content-Type'] = headers['Content-Type'] || 'application/json';\n              const res = await fetch(url, { method, headers, body: body as any });\n              if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\n              return (await res.blob()) as any;\n            })()\n          : await this.requestInternal<T>(endpoint, {\n              method,\n              headers: cfg.headers,\n              body: body as any,\n            });\n\n      return data as T;\n    }\n\n    // Fetch-like style: request('/path', { ... })\n    const endpoint = arg1 as string;\n    const cfg = arg2 || {};\n    return this.requestInternal<T>(endpoint, {\n      method: cfg.method || 'GET',\n      headers: cfg.headers,\n      body: cfg.body as any,\n      timeout: cfg.timeout,\n    });\n  }\n\n  async get<T>(endpoint: string, params?: object): Promise<T> {\n    let url = endpoint;\n    if (params) {\n      const searchParams = new URLSearchParams();\n      Object.entries(params as Record<string, unknown>).forEach(([key, value]) => {\n        if (value !== undefined && value !== null) {\n          searchParams.append(key, String(value));\n        }\n      });\n      url += `?${searchParams.toString()}`;\n    }\n    \n    return this.requestInternal<T>(url, {\n      method: 'GET',\n    });\n  }\n\n  async post<T = any>(\n    endpoint: string,\n    data?: unknown,\n    config?: {\n      onUploadProgress?: (progress: number) => void;\n      headers?: Record<string, string>;\n      responseType?: 'json' | 'blob';\n    }\n  ): Promise<T> {\n    // 如果是 FormData，直接传递，不进行 JSON.stringify\n    if (data instanceof FormData) {\n      const url = `${this.baseURL}${endpoint}`;\n      const headers = this.getHeaders();\n      // FormData 上传时，不要设置 Content-Type，让浏览器自动设置（包含 boundary）\n      delete headers['Content-Type'];\n      \n      // 如果支持上传进度，使用 XMLHttpRequest\n      if (config?.onUploadProgress) {\n        return new Promise<T>((resolve, reject) => {\n          const xhr = new XMLHttpRequest();\n          \n          xhr.upload.addEventListener('progress', (event) => {\n            if (event.lengthComputable && config.onUploadProgress) {\n              const progress = Math.round((event.loaded * 100) / event.total);\n              config.onUploadProgress(progress);\n            }\n          });\n          \n          xhr.addEventListener('load', () => {\n            if (xhr.status >= 200 && xhr.status < 300) {\n              try {\n                const response = JSON.parse(xhr.responseText) as ApiResponse<T>;\n                if (response.code === 0) {\n                  resolve(response.data);\n                } else {\n                  reject(new Error(response.message || 'Request failed'));\n                }\n              } catch (error) {\n                reject(new Error('Failed to parse response'));\n              }\n            } else {\n              reject(new Error(`HTTP error! status: ${xhr.status}`));\n            }\n          });\n          \n          xhr.addEventListener('error', () => {\n            reject(new Error('Network error'));\n          });\n          \n          xhr.open('POST', url);\n          Object.entries(headers).forEach(([key, value]) => {\n            if (key !== 'Content-Type') {\n              xhr.setRequestHeader(key, value);\n            }\n          });\n          xhr.send(data);\n        });\n      }\n      \n      // 不支持进度时，使用 fetch\n      const response = await fetch(url, {\n        method: 'POST',\n        headers: {\n          ...headers,\n          ...(config?.headers || {}),\n        },\n        body: data,\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      \n      if (config?.responseType === 'blob') {\n        return (await response.blob()) as any;\n      }\n\n      const responseData = (await response.json()) as ApiResponse<T>;\n      if (responseData.code !== 0) {\n        throw new Error(responseData.message || 'Request failed');\n      }\n      \n      return responseData.data;\n    }\n    \n    return this.requestInternal<T>(endpoint, {\n      method: 'POST',\n      body: data ? JSON.stringify(data) : undefined,\n      headers: config?.headers,\n    });\n  }\n\n  async put<T>(endpoint: string, data?: unknown): Promise<T> {\n    return this.requestInternal<T>(endpoint, {\n      method: 'PUT',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async patch<T>(endpoint: string, data?: unknown): Promise<T> {\n    return this.requestInternal<T>(endpoint, {\n      method: 'PATCH',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async delete<T = any>(endpoint: string, data?: unknown): Promise<T> {\n    return this.requestInternal<T>(endpoint, {\n      method: 'DELETE',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  // 分页查询方法\n  async getPaginated<T>(\n    endpoint: string, \n    params?: {\n      page?: number;\n      pageSize?: number;\n      sortBy?: string;\n      sortOrder?: 'asc' | 'desc';\n      filters?: Record<string, any>;\n    }\n  ): Promise<{\n    data: T[];\n    total: number;\n    page: number;\n    pageSize: number;\n    totalPages: number;\n  }> {\n    const queryParams = new URLSearchParams();\n    if (params) {\n      Object.entries(params).forEach(([key, value]) => {\n        if (value !== undefined && value !== null) {\n          if (key === 'filters' && typeof value === 'object') {\n            Object.entries(value).forEach(([filterKey, filterValue]) => {\n              if (filterValue !== undefined && filterValue !== null) {\n                queryParams.append(`filters[${filterKey}]`, String(filterValue));\n              }\n            });\n          } else {\n            queryParams.append(key, String(value));\n          }\n        }\n      });\n    }\n    \n    const url = queryParams.toString() \n      ? `${endpoint}?${queryParams.toString()}` \n      : endpoint;\n      \n    return this.get(url);\n  }\n\n  // 批量操作方法\n  async batchOperation<T>(\n    endpoint: string, \n    operation: string, \n    data: any[]\n  ): Promise<T[]> {\n    return this.post<T[]>(endpoint, {\n      operation,\n      data\n    });\n  }\n\n  // 文件上传方法\n  async uploadFile(\n    endpoint: string, \n    file: File, \n    onProgress?: (progress: number) => void\n  ): Promise<{\n    url: string;\n    filename: string;\n    size: number;\n  }> {\n    const formData = new FormData();\n    formData.append('file', file);\n\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest();\n      \n      xhr.upload.addEventListener('progress', (event) => {\n        if (event.lengthComputable && onProgress) {\n          const progress = (event.loaded / event.total) * 100;\n          onProgress(progress);\n        }\n      });\n\n      xhr.addEventListener('load', () => {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          try {\n            const response = JSON.parse(xhr.responseText);\n            resolve(response);\n          } catch (error) {\n            reject(new Error('Invalid response format'));\n          }\n        } else {\n          reject(new Error(`Upload failed: ${xhr.statusText}`));\n        }\n      });\n\n      xhr.addEventListener('error', () => {\n        reject(new Error('Upload failed'));\n      });\n\n      xhr.open('POST', endpoint);\n      \n      // 添加认证头\n      const token = this.getAuthToken();\n      if (token) {\n        xhr.setRequestHeader('Authorization', `Bearer ${token}`);\n      }\n\n      xhr.send(formData);\n    });\n  }\n}\n\nexport const httpClient = new HttpClient();\nexport default HttpClient;\n"],"names":["httpClient","HttpClient","constructor","baseURL","API_BASE_URL","token","tenantId","tenantCode","process","env","NEXT_PUBLIC_API_URL","timeout","parseInt","NEXT_PUBLIC_API_TIMEOUT","window","localStorage","getItem","storedTenantId","setToken","setItem","document","cookie","clearToken","removeItem","setTenantId","toString","setTenantCode","code","logger","info","getTenantCode","getTenantId","getAuthToken","getToken","getBaseURL","getHeaders","csrfToken","security","csrf","getTokenFromMeta","headers","network","getSecureHeaders","undefined","currentToken","currentTenantId","currentTenantCode","refreshTokenInternal","refreshToken","response","fetch","method","body","JSON","stringify","refresh_token","ok","data","json","access_token","error","requestInternal","endpoint","config","url","requestConfig","debug","NODE_ENV","includes","warn","controller","AbortController","timeoutId","setTimeout","abort","signal","clearTimeout","status","statusText","Object","fromEntries","entries","refreshSuccess","retryConfig","retryResponse","rid","get","suffix","Error","retryData","message","location","href","responseData","name","request","arg1","arg2","cfg","params","qs","URLSearchParams","forEach","k","v","append","String","q","FormData","responseType","res","blob","searchParams","key","value","post","onUploadProgress","Promise","resolve","reject","xhr","XMLHttpRequest","upload","addEventListener","event","lengthComputable","progress","Math","round","loaded","total","parse","responseText","open","setRequestHeader","send","put","patch","delete","getPaginated","queryParams","filterKey","filterValue","batchOperation","operation","uploadFile","file","onProgress","formData"],"mappings":"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"}
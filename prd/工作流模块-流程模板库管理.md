# 工作流模块 - 流程模板库管理

## 1. 模板库概述

### 1.1 模板库定位

流程模板库是工作流模块的重要组成部分，提供预置的、经过验证的流程模板，帮助用户快速创建和部署业务流程。

### 1.2 模板库价值

- **提高效率**：无需从零开始设计流程
- **降低门槛**：非技术人员也能使用
- **保证质量**：预置模板经过验证和优化
- **标准化**：统一业务流程标准

### 1.3 模板分类体系

```
流程模板库
├── 工单管理类
│   ├── 标准工单审批流程
│   ├── 紧急工单处理流程
│   ├── 复杂工单多级审批
│   └── 工单自动分配流程
├── 变更管理类
│   ├── 标准变更流程
│   ├── 紧急变更流程
│   ├── 重大变更流程
│   └── 变更回滚流程
├── 服务请求类
│   ├── 服务申请审批流程
│   ├── 资源交付流程
│   ├── 权限申请流程
│   └── 软件申请流程
├── 事件管理类
│   ├── 事件响应流程
│   ├── 事件升级流程
│   └── 事件关闭流程
├── 问题管理类
│   ├── 问题调查流程
│   ├── 根因分析流程
│   └── 问题解决流程
└── 通用流程类
    ├── 简单审批流程
    ├── 并行审批流程
    └── 条件审批流程
```

## 2. 模板库功能设计

### 2.1 模板浏览

#### 2.1.1 浏览方式

- **分类浏览**：按业务模块分类浏览
- **搜索浏览**：按关键词搜索模板
- **标签浏览**：按标签筛选模板
- **热门模板**：显示最常用的模板

#### 2.1.2 模板卡片信息

- 模板名称
- 模板描述
- 模板分类
- 适用场景
- 复杂度评级
- 使用次数
- 评分
- 预览图

### 2.2 模板详情

#### 2.2.1 详情页面内容

- **基本信息**
  - 模板名称、描述
  - 分类、标签
  - 版本信息
  - 创建时间、更新时间
  
- **流程预览**
  - 流程图可视化
  - 流程步骤说明
  - 关键节点标注
  
- **配置说明**
  - 流程变量说明
  - 任务分配规则
  - 超时设置
  - 条件表达式说明
  
- **使用指南**
  - 适用场景
  - 配置步骤
  - 注意事项
  - 常见问题

- **统计信息**
  - 使用次数
  - 平均执行时长
  - 完成率
  - 用户评分

### 2.3 模板使用

#### 2.3.1 使用流程

```
1. 浏览/搜索模板
2. 查看模板详情
3. 预览流程图
4. 选择"使用此模板"
5. 配置流程参数
6. 映射业务变量
7. 测试流程
8. 保存并激活
```

#### 2.3.2 配置向导

- **步骤1：基本信息**
  - 流程名称
  - 流程描述
  - 关联业务模块
  
- **步骤2：变量映射**
  - 映射业务字段到流程变量
  - 设置默认值
  - 配置变量类型
  
- **步骤3：分配规则**
  - 配置任务分配人
  - 设置候选用户/组
  - 配置分配表达式
  
- **步骤4：超时设置**
  - 设置各步骤超时时间
  - 配置超时处理策略
  
- **步骤5：通知配置**
  - 配置任务通知
  - 配置流程通知
  - 配置超时提醒

### 2.4 模板管理

#### 2.4.1 模板创建

- **从模板库创建**：基于现有模板创建
- **从零创建**：使用设计器创建新模板
- **导入创建**：导入BPMN XML文件

#### 2.4.2 模板编辑

- 可视化编辑流程
- 修改流程步骤
- 调整流程变量
- 更新分配规则

#### 2.4.3 模板发布

- **私有模板**：仅创建者可见
- **部门模板**：部门内可见
- **公共模板**：所有用户可见（需审核）

#### 2.4.4 模板分享

- 分享给指定用户
- 分享给指定部门
- 导出模板文件
- 生成分享链接

## 3. 模板库数据结构

### 3.1 模板定义表

```sql
CREATE TABLE workflow_template (
    id SERIAL PRIMARY KEY,
    template_key VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(50) NOT NULL,
    tags TEXT[],  -- 标签数组
    complexity VARCHAR(20),  -- simple/medium/complex
    version VARCHAR(20) DEFAULT '1.0.0',
    
    -- 流程定义
    bpmn_xml BYTEA,  -- BPMN XML内容
    json_definition JSONB,  -- JSON定义（简单工作流）
    
    -- 模板元数据
    process_variables JSONB,  -- 流程变量定义
    assignment_rules JSONB,  -- 分配规则说明
    timeout_config JSONB,  -- 超时配置说明
    condition_expressions JSONB,  -- 条件表达式说明
    
    -- 使用指南
    usage_guide TEXT,  -- 使用指南
    configuration_steps JSONB,  -- 配置步骤
    faq JSONB,  -- 常见问题
    
    -- 统计信息
    usage_count INT DEFAULT 0,  -- 使用次数
    average_duration INT,  -- 平均执行时长（秒）
    completion_rate DECIMAL(5,2),  -- 完成率
    rating DECIMAL(3,2),  -- 评分（0-5）
    rating_count INT DEFAULT 0,  -- 评分人数
    
    -- 权限控制
    visibility VARCHAR(20) DEFAULT 'private',  -- private/department/public
    creator_id INT NOT NULL,
    department_id INT,
    tenant_id INT NOT NULL,
    
    -- 状态
    status VARCHAR(20) DEFAULT 'draft',  -- draft/published/archived
    is_official BOOLEAN DEFAULT false,  -- 是否官方模板
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    published_at TIMESTAMP
);

CREATE INDEX idx_template_category ON workflow_template(category);
CREATE INDEX idx_template_tags ON workflow_template USING GIN(tags);
CREATE INDEX idx_template_visibility ON workflow_template(visibility, tenant_id);
CREATE INDEX idx_template_status ON workflow_template(status);
```

### 3.2 模板使用记录表

```sql
CREATE TABLE workflow_template_usage (
    id SERIAL PRIMARY KEY,
    template_id INT NOT NULL REFERENCES workflow_template(id),
    workflow_definition_id INT NOT NULL,  -- 使用模板创建的流程定义ID
    user_id INT NOT NULL,
    tenant_id INT NOT NULL,
    used_at TIMESTAMP DEFAULT NOW(),
    
    -- 使用统计
    instance_count INT DEFAULT 0,  -- 创建的实例数
    average_duration INT,  -- 平均执行时长
    completion_rate DECIMAL(5,2),  -- 完成率
    
    CONSTRAINT fk_template FOREIGN KEY (template_id) REFERENCES workflow_template(id)
);

CREATE INDEX idx_template_usage_template ON workflow_template_usage(template_id);
CREATE INDEX idx_template_usage_user ON workflow_template_usage(user_id, tenant_id);
```

### 3.3 模板评分表

```sql
CREATE TABLE workflow_template_rating (
    id SERIAL PRIMARY KEY,
    template_id INT NOT NULL REFERENCES workflow_template(id),
    user_id INT NOT NULL,
    tenant_id INT NOT NULL,
    rating INT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    
    CONSTRAINT fk_template FOREIGN KEY (template_id) REFERENCES workflow_template(id),
    CONSTRAINT uk_template_user UNIQUE (template_id, user_id, tenant_id)
);

CREATE INDEX idx_template_rating_template ON workflow_template_rating(template_id);
```

## 4. 模板库API设计

### 4.1 模板浏览API

#### 4.1.1 获取模板列表

```
GET /api/v1/workflow-templates?category=ticket&page=1&size=10&sort=usage_count
Query Parameters:
  - category: 分类筛选
  - tags: 标签筛选（多个）
  - complexity: 复杂度筛选
  - visibility: 可见性筛选
  - search: 关键词搜索
  - sort: 排序方式（usage_count/rating/created_at）
  - page: 页码
  - size: 每页数量

Response:
{
  "code": 200,
  "data": {
    "templates": [
      {
        "id": 1,
        "template_key": "ticket_approval_standard",
        "name": "标准工单审批流程",
        "description": "适用于普通工单的标准审批流程",
        "category": "ticket",
        "tags": ["审批", "工单"],
        "complexity": "medium",
        "usage_count": 150,
        "rating": 4.5,
        "preview_image": "https://..."
      }
    ],
    "total": 50,
    "page": 1,
    "size": 10
  }
}
```

#### 4.1.2 获取模板详情

```
GET /api/v1/workflow-templates/:id
Response:
{
  "code": 200,
  "data": {
    "id": 1,
    "template_key": "ticket_approval_standard",
    "name": "标准工单审批流程",
    "description": "...",
    "category": "ticket",
    "bpmn_xml": "...",
    "json_definition": {...},
    "process_variables": {...},
    "usage_guide": "...",
    "configuration_steps": [...],
    "faq": [...],
    "usage_count": 150,
    "rating": 4.5,
    "rating_count": 30
  }
}
```

### 4.2 模板使用API

#### 4.2.1 使用模板创建流程

```
POST /api/v1/workflow-templates/:id/use
Request Body:
{
  "workflow_name": "我的工单审批流程",
  "workflow_description": "基于标准模板创建",
  "variable_mapping": {
    "ticket_id": "ticket.id",
    "requester_department": "ticket.requester.department"
  },
  "assignment_rules": {
    "manager_approval": {
      "type": "expression",
      "expression": "${assigneeService.getManagerByDepartment(requester_department)}"
    }
  },
  "timeout_config": {
    "manager_approval": 1440,
    "it_approval": 2880
  }
}

Response:
{
  "code": 200,
  "data": {
    "workflow_definition_id": 123,
    "workflow_key": "my_ticket_approval_workflow",
    "message": "流程创建成功"
  }
}
```

### 4.3 模板管理API

#### 4.3.1 创建模板

```
POST /api/v1/workflow-templates
Request Body:
{
  "template_key": "my_custom_template",
  "name": "我的自定义模板",
  "description": "...",
  "category": "ticket",
  "tags": ["自定义"],
  "bpmn_xml": "...",
  "visibility": "private"
}
```

#### 4.3.2 更新模板

```
PUT /api/v1/workflow-templates/:id
```

#### 4.3.3 删除模板

```
DELETE /api/v1/workflow-templates/:id
```

#### 4.3.4 发布模板

```
POST /api/v1/workflow-templates/:id/publish
Request Body:
{
  "visibility": "public"  // private/department/public
}
```

### 4.4 模板评分API

#### 4.4.1 提交评分

```
POST /api/v1/workflow-templates/:id/rating
Request Body:
{
  "rating": 5,
  "comment": "非常好用的模板"
}
```

#### 4.4.2 获取评分列表

```
GET /api/v1/workflow-templates/:id/ratings?page=1&size=10
```

## 5. 模板库前端设计

### 5.1 模板库首页

#### 5.1.1 布局设计

```
┌─────────────────────────────────────────┐
│  模板库                                 │
├─────────────────────────────────────────┤
│  [搜索框]  [分类筛选]  [标签筛选]      │
├─────────────────────────────────────────┤
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐  │
│  │模板1 │ │模板2 │ │模板3 │ │模板4 │  │
│  │[预览]│ │[预览]│ │[预览]│ │[预览]│  │
│  │使用  │ │使用  │ │使用  │ │使用  │  │
│  └──────┘ └──────┘ └──────┘ └──────┘  │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐  │
│  │模板5 │ │模板6 │ │模板7 │ │模板8 │  │
│  └──────┘ └──────┘ └──────┘ └──────┘  │
├─────────────────────────────────────────┤
│  [分页控件]                             │
└─────────────────────────────────────────┘
```

#### 5.1.2 功能特性

- **搜索功能**：实时搜索模板
- **筛选功能**：多维度筛选
- **排序功能**：按使用量、评分、时间排序
- **预览功能**：鼠标悬停预览模板信息
- **快速使用**：一键使用模板

### 5.2 模板详情页

#### 5.2.1 布局设计

```
┌─────────────────────────────────────────┐
│  [返回]  标准工单审批流程                │
├─────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐    │
│  │  基本信息    │  │  统计信息    │    │
│  │  名称: ...   │  │  使用: 150次 │    │
│  │  分类: ...   │  │  评分: 4.5   │    │
│  │  标签: ...   │  │  时长: 2.5h  │    │
│  └──────────────┘  └──────────────┘    │
├─────────────────────────────────────────┤
│  ┌──────────────────────────────────┐  │
│  │        流程图预览                 │  │
│  │                                  │  │
│  │      [BPMN流程图可视化]          │  │
│  │                                  │  │
│  └──────────────────────────────────┘  │
├─────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐    │
│  │  配置说明    │  │  使用指南    │    │
│  │  - 变量定义  │  │  - 适用场景  │    │
│  │  - 分配规则  │  │  - 配置步骤  │    │
│  │  - 超时设置  │  │  - 注意事项  │    │
│  └──────────────┘  └──────────────┘    │
├─────────────────────────────────────────┤
│  [使用此模板]  [收藏]  [分享]  [评分]   │
└─────────────────────────────────────────┘
```

### 5.3 模板配置向导

#### 5.3.1 向导步骤

```tsx
<Steps current={currentStep}>
  <Step title="基本信息" />
  <Step title="变量映射" />
  <Step title="分配规则" />
  <Step title="超时设置" />
  <Step title="通知配置" />
  <Step title="完成" />
</Steps>
```

#### 5.3.2 配置表单

- 步骤式表单设计
- 实时验证
- 配置预览
- 保存草稿

## 6. 模板库运营策略

### 6.1 模板质量保证

#### 6.1.1 官方模板标准

- 流程设计合理
- 经过充分测试
- 文档完整
- 性能优化

#### 6.1.2 模板审核机制

- 用户提交的公共模板需审核
- 审核内容包括：流程合理性、安全性、性能
- 审核通过后发布

### 6.2 模板推广策略

#### 6.2.1 推荐机制

- **热门模板**：使用量高的模板
- **新模板**：最新发布的模板
- **推荐模板**：基于用户行为的推荐
- **官方推荐**：官方精选模板

#### 6.2.2 激励机制

- 模板创建奖励
- 模板使用奖励
- 模板评分奖励
- 优秀模板评选

### 6.3 模板维护策略

#### 6.3.1 版本更新

- 定期更新模板
- 修复已知问题
- 优化流程性能
- 更新文档

#### 6.3.2 模板归档

- 过时模板归档
- 低质量模板下架
- 保留历史版本

---

**文档版本**：V1.0  
**创建日期**：2025-12-17  
**最后更新**：2025-12-17  
**维护人**：产品团队

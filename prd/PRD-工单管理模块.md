# PRD - 工单管理模块

## 文档信息

- **文档版本**: v1.1
- **创建日期**: 2024-12-19
- **产品经理**: [待填写]
- **最后更新**: 2024-12-19
- **状态**: 已更新实现状态
- **改进版PRD**: 参见 `PRD-工单管理模块-v2.0-改进版.md`

---

## 1. 产品概述

### 1.1 产品定位

工单管理模块是ITSM系统的核心业务模块，用于统一管理企业内部各类服务请求、问题报告、变更申请等工单，实现工单全生命周期管理，提升服务效率和用户满意度。

### 1.2 产品目标

1. **提升服务效率**：通过标准化流程和自动化分配，减少工单处理时间
2. **提高服务质量**：通过SLA监控和质量评估，确保服务标准
3. **优化用户体验**：提供便捷的工单提交和查询渠道，提升用户满意度
4. **数据驱动决策**：通过统计分析，为管理决策提供数据支持

### 1.3 目标用户

| 用户角色 | 主要需求 | 使用场景 |
|---------|---------|---------|
| **终端用户** | 提交工单、查询工单状态、评价服务 | 遇到IT问题时提交工单，跟踪处理进度 |
| **服务台人员** | 接收工单、分配工单、处理工单、回复用户 | 处理用户提交的各类服务请求 |
| **技术人员** | 接收分配、处理工单、更新状态、记录解决方案 | 解决技术问题，记录解决方案 |
| **团队负责人** | 查看团队工单、分配任务、监控SLA | 管理团队工作负载，确保服务质量 |
| **系统管理员** | 配置工单分类、模板、SLA、工作流 | 维护系统配置，优化流程 |

---

## 2. 现状分析

### 2.1 当前实现情况

#### 2.1.1 数据模型

**工单核心字段**：

- 基本信息：标题、描述、工单编号（唯一）
- 状态管理：状态（待处理/进行中/已解决/已关闭）、优先级（低/中/高/紧急）
- 人员关联：申请人ID、处理人ID
- 组织关联：部门ID、分类ID、模板ID
- 时间管理：创建时间、更新时间、首次响应时间、解决时间
- SLA管理：SLA定义ID、响应截止时间、解决截止时间

**关联关系**：

- 工单模板（一对多）
- 工单分类（一对多）
- 部门（多对一）
- 工单标签（多对多）
- 关联工单（自关联，支持父子工单）
- 工作流实例（一对多）
- SLA定义（多对一）
- SLA违规记录（一对多）

#### 2.1.2 后端功能

**已实现功能**：

- ✅ 工单CRUD（创建、查询、更新、删除）
- ✅ 工单分配（手动分配、自动分配）
- ✅ 工单升级（优先级升级、处理人升级）
- ✅ 工单状态流转（解决、关闭）
- ✅ 工单搜索和筛选（多条件组合查询）
- ✅ 工单统计（按状态、优先级、分类等统计）
- ✅ 工单分析（趋势分析、性能分析）
- ✅ 工单导入导出（CSV、Excel、PDF）
- ✅ 工单模板管理
- ✅ 工单工作流（接单、驳回、转派等）
- ✅ 工单标签管理
- ✅ 工单关联管理
- ✅ SLA管理（SLA定义、SLA监控、SLA违规）

**API端点**：

```
GET    /api/v1/tickets              # 获取工单列表
POST   /api/v1/tickets              # 创建工单
GET    /api/v1/tickets/:id          # 获取工单详情
PUT    /api/v1/tickets/:id          # 更新工单
DELETE /api/v1/tickets/:id          # 删除工单
POST   /api/v1/tickets/:id/assign   # 分配工单
POST   /api/v1/tickets/:id/escalate # 升级工单
POST   /api/v1/tickets/:id/resolve  # 解决工单
POST   /api/v1/tickets/:id/close    # 关闭工单
GET    /api/v1/tickets/search       # 搜索工单
GET    /api/v1/tickets/stats        # 获取工单统计
GET    /api/v1/tickets/analytics    # 获取工单分析
POST   /api/v1/tickets/export       # 导出工单
POST   /api/v1/tickets/import       # 导入工单
GET    /api/v1/tickets/templates    # 获取工单模板列表
POST   /api/v1/tickets/templates    # 创建工单模板
```

#### 2.1.3 前端功能

**已实现功能**：

- ✅ 工单列表（表格视图、卡片视图）
- ✅ 工单筛选（状态、优先级、分类、处理人等）
- ✅ 工单搜索（关键词搜索）
- ✅ 工单详情页
- ✅ 工单创建/编辑表单
- ✅ 工单统计展示
- ✅ 工单趋势图表

**页面路径**：

- `/tickets` - 工单列表页
- `/tickets/:id` - 工单详情页
- `/tickets/create` - 创建工单页

### 2.2 功能缺口分析

#### 2.2.1 核心功能状态

1. **工单评论/沟通功能**
   - ✅ 工单评论系统已实现
   - ✅ 内部备注功能已实现
   - ✅ @提醒功能已实现
   - ✅ 评论附件上传已实现
   - **状态**：已完成

2. **工单附件管理**
   - ✅ 附件上传功能已实现
   - ✅ 附件预览功能已实现
   - ✅ 附件下载功能已实现
   - ✅ 附件删除功能已实现
   - **状态**：已完成

3. **工单通知系统**
   - ✅ 站内消息通知已实现
   - ⚠️ 邮件通知部分实现
   - ❌ 短信通知未实现（可选）
   - **状态**：基本完成，邮件通知需完善

4. **工单评分/满意度调查**
   - ✅ 工单解决后评分功能已实现
   - ✅ 评分统计分析已实现
   - ⚠️ 满意度调查问卷未实现（可选）
   - **状态**：核心功能已完成

5. **工单知识库关联**
   - ❌ 缺少解决方案知识库关联
   - ❌ 缺少常见问题推荐
   - ❌ 缺少解决方案模板
   - **影响**：无法复用历史解决方案，影响处理效率

#### 2.2.2 高级功能状态

1. **智能分配**
   - ✅ 基于技能矩阵的自动分配已实现
   - ✅ 基于工作负载的智能分配已实现
   - ✅ 基于历史数据的推荐分配已实现
   - ✅ 分配规则配置已实现
   - **状态**：已完成

2. **工单预测分析**
   - ❌ 缺少工单量预测
   - ❌ 缺少工单趋势预测
   - ❌ 缺少资源需求预测
   - **影响**：无法提前规划资源，应对高峰期
   - **状态**：未实现

3. **移动端支持**
   - ❌ 缺少移动端H5页面
   - ❌ 缺少移动端APP
   - ❌ 缺少微信小程序
   - **影响**：用户无法随时随地提交和查询工单
   - **状态**：未实现

4. **工单自动化**
   - ✅ 自动化规则引擎已实现
   - ✅ 自动分类已实现
   - ✅ 自动分配规则已实现
   - ✅ 自动升级规则已实现
   - **状态**：已完成

5. **多语言支持**
   - ❌ 缺少国际化支持
   - ❌ 缺少多语言界面
   - **影响**：无法支持国际化企业需求

#### 2.2.3 用户体验问题

1. **工单创建体验**
   - ⚠️ 缺少智能提示（基于历史工单）
   - ⚠️ 缺少表单验证增强
   - ⚠️ 缺少草稿保存功能
   - **影响**：用户创建工单体验不够友好

2. **工单查询体验**
   - ✅ 高级筛选器已实现（多条件组合）
   - ✅ 保存的筛选条件已实现（视图管理）
   - ✅ 工单视图自定义已实现
   - ✅ 实时筛选和筛选标签已实现
   - ⚠️ 筛选预设功能未实现
   - **状态**：基本完成，待优化

3. **工单详情体验**
   - ✅ 固定顶部状态栏已实现
   - ✅ 标签页重组已实现（基本信息、沟通记录、系统信息）
   - ⚠️ 时间线视图需要优化
   - ⚠️ 操作历史记录需要优化
   - **状态**：基本完成，待优化

---

## 3. 功能需求

### 3.1 核心功能需求（P0）

#### 3.1.1 工单评论系统

**需求描述**：

- 支持在工单中添加评论（公开评论和内部备注）
- 支持@用户提醒功能
- 支持评论编辑和删除
- 支持评论附件上传
- 支持评论通知

**验收标准**：

- [ ] 可以在工单详情页添加评论
- [ ] 评论支持富文本编辑
- [ ] 支持@用户，被@用户收到通知
- [ ] 支持内部备注（仅处理人可见）
- [ ] 评论可以编辑和删除（仅作者和工单处理人）
- [ ] 评论支持附件上传
- [ ] 评论列表按时间倒序显示

**优先级**: P0
**工作量**: 2天

#### 3.1.2 工单附件管理

**需求描述**：

- 支持在工单创建和更新时上传附件
- 支持附件预览（图片、PDF、Office文档）
- 支持附件下载
- 支持附件大小和类型限制
- 支持附件病毒扫描（可选）

**验收标准**：

- [ ] 工单创建和编辑时支持上传附件
- [ ] 支持多文件上传
- [ ] 附件大小限制（如10MB）
- [ ] 附件类型限制（可配置）
- [ ] 支持图片、PDF、Office文档预览
- [ ] 支持附件下载
- [ ] 附件列表显示文件大小、上传时间、上传人

**优先级**: P0
**工作量**: 2天

#### 3.1.3 工单通知系统

**需求描述**：

- 工单创建时通知处理人
- 工单状态变更时通知相关用户
- 工单分配时通知新处理人
- 工单评论时通知相关人员
- 工单SLA即将到期时通知
- 支持邮件、站内消息、短信（可选）通知

**验收标准**：

- [ ] 工单创建时发送通知给处理人
- [ ] 工单状态变更时通知申请人和处理人
- [ ] 工单分配时通知新处理人
- [ ] 工单评论时通知相关人员
- [ ] SLA即将到期时发送提醒（可配置提前时间）
- [ ] 支持邮件通知
- [ ] 支持站内消息通知
- [ ] 支持通知模板配置
- [ ] 支持用户通知偏好设置

**优先级**: P0
**工作量**: 3天

#### 3.1.4 工单评分系统

**需求描述**：

- 工单解决后，申请人可以对服务进行评分
- 支持1-5星评分
- 支持评分评论
- 支持评分统计分析
- 支持满意度调查问卷（可选）

**验收标准**：

- [ ] 工单解决后，申请人可以评分
- [ ] 支持1-5星评分
- [ ] 支持评分评论
- [ ] 评分后发送通知给处理人
- [ ] 支持评分统计分析（平均分、评分分布等）
- [ ] 支持按处理人、分类等维度统计评分
- [ ] 评分数据用于服务质量评估

**优先级**: P0
**工作量**: 2天

### 3.2 重要功能需求（P1）

#### 3.2.1 智能分配系统

**需求描述**：

- 基于技能矩阵自动匹配处理人
- 基于工作负载智能分配
- 基于历史数据推荐处理人
- 支持分配规则配置

**验收标准**：

- [ ] 支持基于工单分类和技能矩阵自动分配
- [ ] 支持基于当前工作负载分配（优先分配给空闲人员）
- [ ] 支持基于历史处理记录推荐（推荐处理过类似工单的人员）
- [ ] 支持分配规则配置（规则引擎）
- [ ] 支持手动分配和自动分配切换

**优先级**: P1
**工作量**: 3天

#### 3.2.2 工单知识库关联

**需求描述**：

- 工单解决后可以创建知识库条目
- 创建工单时推荐相关知识库文章
- 处理工单时可以参考历史解决方案
- 支持解决方案模板

**验收标准**：

- [ ] 工单解决时可以创建知识库条目
- [ ] 创建工单时基于关键词推荐相关文章
- [ ] 处理工单时可以查看历史类似工单的解决方案
- [ ] 支持解决方案模板
- [ ] 知识库文章可以关联到工单分类

**优先级**: P1
**工作量**: 2天

#### 3.2.3 工单自动化规则

**需求描述**：

- 支持自动化规则配置
- 支持自动分类规则
- 支持自动分配规则
- 支持自动升级规则
- 支持条件触发动作

**验收标准**：

- [ ] 支持规则引擎配置
- [ ] 支持基于条件自动分类
- [ ] 支持基于条件自动分配
- [ ] 支持基于条件自动升级
- [ ] 支持规则优先级设置
- [ ] 支持规则测试功能

**优先级**: P1
**工作量**: 4天

#### 3.2.4 工单高级筛选和视图

**需求描述**：

- 支持高级筛选器（多条件组合）
- 支持保存筛选条件
- 支持自定义视图
- 支持视图共享

**验收标准**：

- [ ] 支持多条件组合筛选
- [ ] 支持保存筛选条件为视图
- [ ] 支持自定义视图（选择显示的列）
- [ ] 支持视图共享给团队
- [ ] 支持视图排序和分组

**优先级**: P1
**工作量**: 2天

### 3.3 增强功能需求（P2）

#### 3.3.1 移动端支持

**需求描述**：

- 开发移动端H5页面
- 支持工单创建、查询、处理
- 支持移动端通知推送
- 支持移动端附件上传（拍照）

**验收标准**：

- [ ] 移动端H5页面适配
- [ ] 支持移动端工单创建
- [ ] 支持移动端工单查询和处理
- [ ] 支持移动端通知推送
- [ ] 支持移动端拍照上传附件

**优先级**: P2
**工作量**: 5天

#### 3.3.2 工单预测分析

**需求描述**：

- 基于历史数据预测工单量
- 预测工单趋势
- 预测资源需求
- 提供预测报告

**验收标准**：

- [ ] 支持基于历史数据预测未来工单量
- [ ] 支持预测工单趋势（增长/下降）
- [ ] 支持预测资源需求（需要多少人处理）
- [ ] 提供预测报告和可视化图表

**优先级**: P2
**工作量**: 3天

#### 3.3.3 多语言支持

**需求描述**：

- 支持国际化（i18n）
- 支持多语言界面
- 支持多语言通知模板

**验收标准**：

- [ ] 支持中英文切换
- [ ] 支持多语言界面
- [ ] 支持多语言通知模板
- [ ] 支持语言包扩展

**优先级**: P2
**工作量**: 2天

---

## 4. 非功能需求

### 4.1 性能需求

- **响应时间**：工单列表加载时间 < 2秒
- **并发支持**：支持1000+并发用户
- **数据量**：支持百万级工单数据
- **附件上传**：支持单文件最大50MB

### 4.2 安全需求

- **权限控制**：基于RBAC的细粒度权限控制
- **数据隔离**：多租户数据完全隔离
- **审计日志**：记录所有工单操作日志
- **附件安全**：附件病毒扫描、文件类型验证

### 4.3 可用性需求

- **系统可用性**：99.9%可用性
- **数据备份**：每日自动备份
- **灾难恢复**：支持数据恢复

### 4.4 兼容性需求

- **浏览器支持**：Chrome、Firefox、Safari、Edge最新版本
- **移动端支持**：iOS 12+、Android 8+
- **响应式设计**：支持PC、平板、手机

---

## 5. 技术架构

### 5.1 后端架构

- **框架**：Go + Gin
- **ORM**：Ent
- **数据库**：PostgreSQL/MySQL
- **消息队列**：RabbitMQ/Kafka（用于通知）
- **文件存储**：本地存储/OSS（用于附件）

### 5.2 前端架构

- **框架**：Next.js + React
- **UI组件**：Ant Design
- **状态管理**：Zustand
- **数据获取**：React Query
- **图表库**：Ant Design Charts

### 5.3 集成接口

- **邮件服务**：SMTP/邮件服务API
- **短信服务**：短信服务API（可选）
- **文件存储**：OSS/S3 API
- **知识库**：知识库模块API

---

## 6. 数据模型

### 6.1 工单表（tickets）

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| id | int | 主键 | 是 |
| ticket_number | string | 工单编号（唯一） | 是 |
| title | string | 工单标题 | 是 |
| description | text | 工单描述 | 否 |
| status | string | 状态（待处理/进行中/已解决/已关闭） | 是 |
| priority | string | 优先级（低/中/高/紧急） | 是 |
| requester_id | int | 申请人ID | 是 |
| assignee_id | int | 处理人ID | 否 |
| category_id | int | 分类ID | 否 |
| department_id | int | 部门ID | 否 |
| template_id | int | 模板ID | 否 |
| parent_ticket_id | int | 父工单ID | 否 |
| sla_definition_id | int | SLA定义ID | 否 |
| sla_response_deadline | datetime | SLA响应截止时间 | 否 |
| sla_resolution_deadline | datetime | SLA解决截止时间 | 否 |
| first_response_at | datetime | 首次响应时间 | 否 |
| resolved_at | datetime | 解决时间 | 否 |
| rating | int | 评分（1-5） | 否 |
| rating_comment | text | 评分评论 | 否 |
| tenant_id | int | 租户ID | 是 |
| created_at | datetime | 创建时间 | 是 |
| updated_at | datetime | 更新时间 | 是 |

### 6.2 工单评论表（ticket_comments）

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| id | int | 主键 | 是 |
| ticket_id | int | 工单ID | 是 |
| user_id | int | 评论人ID | 是 |
| content | text | 评论内容 | 是 |
| is_internal | boolean | 是否内部备注 | 是 |
| mentions | json | @的用户列表 | 否 |
| attachments | json | 附件列表 | 否 |
| created_at | datetime | 创建时间 | 是 |
| updated_at | datetime | 更新时间 | 是 |

### 6.3 工单附件表（ticket_attachments）

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| id | int | 主键 | 是 |
| ticket_id | int | 工单ID | 是 |
| file_name | string | 文件名 | 是 |
| file_path | string | 文件路径 | 是 |
| file_size | int | 文件大小（字节） | 是 |
| file_type | string | 文件类型 | 是 |
| uploaded_by | int | 上传人ID | 是 |
| created_at | datetime | 创建时间 | 是 |

### 6.4 工单通知表（ticket_notifications）

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| id | int | 主键 | 是 |
| ticket_id | int | 工单ID | 是 |
| user_id | int | 接收人ID | 是 |
| type | string | 通知类型 | 是 |
| channel | string | 通知渠道 | 是 |
| content | text | 通知内容 | 是 |
| sent_at | datetime | 发送时间 | 否 |
| read_at | datetime | 阅读时间 | 否 |
| status | string | 状态（待发送/已发送/已阅读） | 是 |

---

## 7. 用户界面设计

### 7.1 工单列表页

**布局**：

- 顶部：筛选器、搜索框、创建按钮
- 左侧：统计卡片（总工单数、待处理、进行中、已解决）
- 中间：工单列表（表格/卡片视图切换）
- 右侧：工单详情侧边栏（可选）

**功能**：

- 多条件筛选
- 关键词搜索
- 排序和分组
- 批量操作
- 视图切换

### 7.2 工单详情页

**布局**：

- 顶部：工单基本信息、操作按钮
- 左侧：工单详情、评论列表
- 右侧：工单信息（处理人、状态、SLA、关联信息）
- 底部：操作历史时间线

**功能**：

- 工单信息编辑
- 状态流转
- 添加评论
- 上传附件
- 查看历史

### 7.3 工单创建页

**布局**：

- 表单区域：标题、描述、分类、优先级、附件
- 右侧：智能提示、相关文章推荐

**功能**：

- 表单验证
- 智能提示
- 草稿保存
- 模板选择

---

## 8. 验收标准

### 8.1 功能验收

- [ ] 所有P0功能需求已实现并通过测试
- [ ] 所有P1功能需求已实现并通过测试
- [ ] 所有API接口符合RESTful规范
- [ ] 前端页面响应式设计正常
- [ ] 权限控制正确实现

### 8.2 性能验收

- [ ] 工单列表加载时间 < 2秒
- [ ] 支持1000+并发用户
- [ ] 附件上传成功率 > 99%
- [ ] 通知发送延迟 < 5秒

### 8.3 安全验收

- [ ] 通过安全扫描
- [ ] 权限控制测试通过
- [ ] 数据隔离测试通过
- [ ] 审计日志完整

---

## 9. 开发计划

### 9.1 第一阶段：核心功能（2周）

- 工单评论系统（2天）
- 工单附件管理（2天）
- 工单通知系统（3天）
- 工单评分系统（2天）

### 9.2 第二阶段：重要功能（2周）

- 智能分配系统（3天）
- 工单知识库关联（2天）
- 工单自动化规则（4天）
- 工单高级筛选和视图（2天）

### 9.3 第三阶段：增强功能（2周）

- 移动端支持（5天）
- 工单预测分析（3天）
- 多语言支持（2天）

---

## 10. 风险评估

### 10.1 技术风险

- **风险**：附件存储和预览技术复杂度高
- **应对**：使用成熟的OSS服务和预览服务

### 10.2 业务风险

- **风险**：用户对新增功能接受度不高
- **应对**：充分调研用户需求，提供培训

### 10.3 进度风险

- **风险**：开发进度可能延期
- **应对**：合理评估工作量，预留缓冲时间

---

## 11. 附录

### 11.1 术语表

- **工单（Ticket）**：服务请求、问题报告等的统称
- **SLA（Service Level Agreement）**：服务级别协议
- **工作流（Workflow）**：工单处理流程
- **知识库（Knowledge Base）**：解决方案知识库

### 11.2 参考文档

- ITSM系统总体架构文档
- 用户权限管理文档
- 通知系统设计文档
- 知识库模块PRD

---

## 12. 版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2024-12-19 | [待填写] | 初始版本 |
| v1.1 | 2024-12-19 | 资深产品经理 | 更新实现状态 |
| v2.0 | 2024-12-19 | 资深产品经理 | 改进版（参见改进版PRD） |

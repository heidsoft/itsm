# 工作流模块 - 可视化图表

## 1. 工作流模块整体架构图

```mermaid
graph TB
    subgraph "前端层"
        A1[流程设计器]
        A2[流程监控]
        A3[任务待办]
        A4[流程分析]
    end
    
    subgraph "API层"
        B1[WorkflowController]
        B2[BPMNWorkflowController]
    end
    
    subgraph "服务层"
        C1[WorkflowService]
        C2[ProcessEngine]
        C3[TaskService]
        C4[GatewayEngine]
    end
    
    subgraph "引擎层"
        D1[BPMN解析器]
        D2[流程执行器]
        D3[任务调度器]
        D4[事件处理器]
    end
    
    subgraph "数据层"
        E1[(ProcessDefinition)]
        E2[(ProcessInstance)]
        E3[(ProcessTask)]
        E4[(ExecutionHistory)]
    end
    
    A1 --> B2
    A2 --> B2
    A3 --> B2
    A4 --> B2
    
    B1 --> C1
    B2 --> C2
    
    C1 --> D2
    C2 --> D1
    C2 --> D2
    C3 --> D3
    C4 --> D2
    
    D1 --> E1
    D2 --> E2
    D3 --> E3
    D4 --> E4
```

## 2. 双引擎架构对比

```mermaid
graph LR
    subgraph "简单工作流引擎"
        A1[JSON定义]
        A2[轻量级执行]
        A3[基础功能]
    end
    
    subgraph "BPMN流程引擎"
        B1[BPMN XML]
        B2[完整BPMN支持]
        B3[高级功能]
    end
    
    A1 --> A2
    A2 --> A3
    
    B1 --> B2
    B2 --> B3
    
    A3 -.适用简单场景.-> C[选择引擎]
    B3 -.适用复杂场景.-> C
```

## 3. 流程定义生命周期

```mermaid
stateDiagram-v2
    [*] --> 创建: 创建流程定义
    创建 --> 草稿: 保存未发布
    草稿 --> 已发布: 发布流程
    已发布 --> 激活: 激活流程
    激活 --> 运行中: 有实例运行
    运行中 --> 已停用: 停用流程
    已停用 --> 激活: 重新激活
    已停用 --> 已归档: 归档流程
    已归档 --> [*]
    
    note right of 创建
        支持BPMN XML
        或JSON定义
    end note
    
    note right of 激活
        仅最新版本
        可激活
    end note
```

## 4. 流程实例执行流程

```mermaid
sequenceDiagram
    participant U as 用户/系统
    participant API as API层
    participant Engine as 流程引擎
    participant Parser as BPMN解析器
    participant DB as 数据库
    participant Task as 任务服务
    
    U->>API: 启动流程
    API->>Engine: StartProcess()
    Engine->>DB: 获取流程定义
    DB-->>Engine: 返回定义
    Engine->>Parser: 解析BPMN XML
    Parser-->>Engine: 返回流程模型
    Engine->>DB: 创建流程实例
    DB-->>Engine: 返回实例ID
    Engine->>Engine: 执行开始事件
    Engine->>Engine: 推进到第一个活动
    alt 用户任务
        Engine->>Task: 创建用户任务
        Task->>DB: 保存任务
        Task-->>U: 发送通知
        U->>Task: 完成任务
        Task->>Engine: 通知任务完成
    else 服务任务
        Engine->>Engine: 执行服务任务
    end
    Engine->>Engine: 推进流程
    Engine->>DB: 更新实例状态
    Engine-->>API: 返回结果
    API-->>U: 返回响应
```

## 5. 任务处理流程

```mermaid
graph TD
    A[任务创建] --> B{任务类型}
    B -->|用户任务| C[分配给用户]
    B -->|服务任务| D[自动执行]
    B -->|脚本任务| E[执行脚本]
    
    C --> F[用户接收任务]
    F --> G[用户处理任务]
    G --> H{处理结果}
    H -->|完成| I[更新流程变量]
    H -->|取消| J[回退流程]
    H -->|委托| K[转给他人]
    
    D --> L[调用服务]
    L --> M{执行结果}
    M -->|成功| I
    M -->|失败| N[重试/失败]
    
    E --> O[执行脚本]
    O --> P{执行结果}
    P -->|成功| I
    P -->|失败| N
    
    I --> Q[推进到下一节点]
    J --> R[流程回退]
    K --> F
    N --> S[异常处理]
```

## 6. 网关执行流程

```mermaid
graph TB
    subgraph "排他网关"
        A1[评估条件1] -->|true| A2[执行路径1]
        A1 -->|false| A3[评估条件2]
        A3 -->|true| A4[执行路径2]
        A3 -->|false| A5[评估条件3]
        A5 -->|true| A6[执行路径3]
        A5 -->|false| A7[异常:无路径可选]
    end
    
    subgraph "并行网关-分叉"
        B1[并行网关] --> B2[路径1]
        B1 --> B3[路径2]
        B1 --> B4[路径3]
        B2 --> B5[并行执行]
        B3 --> B5
        B4 --> B5
    end
    
    subgraph "并行网关-合并"
        C1[路径1完成] --> C3[等待所有路径]
        C2[路径2完成] --> C3
        C3 --> C4[所有路径完成]
        C4 --> C5[继续执行]
    end
    
    subgraph "包容网关"
        D1[评估所有条件] --> D2{条件1}
        D2 -->|true| D3[执行路径1]
        D2 -->|false| D4{条件2}
        D4 -->|true| D5[执行路径2]
        D4 -->|false| D6{条件3}
        D6 -->|true| D7[执行路径3]
        D3 --> D8[至少一条路径]
        D5 --> D8
        D7 --> D8
        D8 --> D9[继续执行]
    end
```

## 7. 流程实例状态流转

```mermaid
stateDiagram-v2
    [*] --> 创建中: 启动流程
    创建中 --> 运行中: 创建成功
    运行中 --> 暂停: 暂停操作
    暂停 --> 运行中: 恢复操作
    运行中 --> 已完成: 正常结束
    运行中 --> 已终止: 终止操作
    已完成 --> [*]
    已终止 --> [*]
    
    note right of 运行中
        执行流程步骤
        处理任务
        推进流程
    end note
    
    note right of 暂停
        等待外部事件
        人工干预
        系统维护
    end note
```

## 8. 任务状态流转

```mermaid
stateDiagram-v2
    [*] --> 待分配: 任务创建
    待分配 --> 已分配: 分配任务
    已分配 --> 处理中: 开始处理
    处理中 --> 已完成: 完成任务
    处理中 --> 已取消: 取消任务
    已分配 --> 已委托: 委托任务
    已委托 --> 已分配: 新分配人接收
    已分配 --> 已升级: 任务升级
    已完成 --> [*]
    已取消 --> [*]
    
    note right of 待分配
        候选用户/组
        等待分配
    end note
    
    note right of 已升级
        超时升级
        手动升级
    end note
```

## 9. 流程与业务模块集成

```mermaid
graph TB
    subgraph "工单模块"
        A1[工单创建]
        A2[工单更新]
        A3[工单状态]
    end
    
    subgraph "工作流模块"
        B1[流程启动]
        B2[任务创建]
        B3[流程推进]
        B4[流程完成]
    end
    
    subgraph "审批模块"
        C1[审批记录]
        C2[审批结果]
    end
    
    subgraph "通知模块"
        D1[任务通知]
        D2[流程通知]
    end
    
    A1 -->|触发| B1
    B1 --> B2
    B2 -->|创建| C1
    B2 -->|发送| D1
    C2 -->|通知| B3
    B3 -->|更新| A2
    B4 -->|更新| A3
    B4 -->|发送| D2
```

## 10. BPMN元素支持矩阵

```mermaid
graph TB
    subgraph "事件"
        A1[开始事件]
        A2[结束事件]
        A3[中间事件]
        A4[边界事件]
    end
    
    subgraph "任务"
        B1[用户任务]
        B2[服务任务]
        B3[脚本任务]
        B4[业务规则任务]
        B5[手动任务]
    end
    
    subgraph "网关"
        C1[排他网关]
        C2[并行网关]
        C3[包容网关]
    end
    
    subgraph "子流程"
        D1[嵌入子流程]
        D2[调用子流程]
    end
    
    A1 --> B1
    B1 --> C1
    C1 --> B2
    B2 --> C2
    C2 --> D1
    D1 --> C3
    C3 --> A2
```

## 11. 流程执行路径示例

### 11.1 简单审批流程

```mermaid
graph LR
    A[开始] --> B[部门主管审批]
    B -->|通过| C[IT审批]
    B -->|拒绝| E[结束-拒绝]
    C -->|通过| D[安全审批]
    C -->|拒绝| E
    D -->|通过| F[结束-通过]
    D -->|拒绝| E
```

### 11.2 并行审批流程

```mermaid
graph TB
    A[开始] --> B[并行网关-分叉]
    B --> C[技术审批]
    B --> D[安全审批]
    B --> E[合规审批]
    C --> F[并行网关-合并]
    D --> F
    E --> F
    F --> G[所有审批通过]
    G --> H[结束]
```

### 11.3 条件分支流程

```mermaid
graph TB
    A[开始] --> B{优先级判断}
    B -->|高优先级| C[紧急处理]
    B -->|中优先级| D[标准处理]
    B -->|低优先级| E[普通处理]
    C --> F[完成]
    D --> F
    E --> F
```

## 12. 流程监控仪表盘

```mermaid
graph TB
    subgraph "实时监控"
        A1[运行中流程数]
        A2[待处理任务数]
        A3[今日完成数]
        A4[平均处理时长]
    end
    
    subgraph "流程统计"
        B1[流程执行次数]
        B2[流程完成率]
        B3[流程超时率]
        B4[流程分布]
    end
    
    subgraph "任务统计"
        C1[任务完成率]
        C2[任务平均时长]
        C3[任务超时数]
        C4[任务分布]
    end
    
    subgraph "性能分析"
        D1[瓶颈节点]
        D2[优化建议]
        D3[趋势分析]
    end
```

## 13. 异常处理流程

```mermaid
graph TD
    A[流程执行] --> B{是否异常}
    B -->|正常| C[继续执行]
    B -->|异常| D{异常类型}
    D -->|任务超时| E[任务超时处理]
    D -->|服务调用失败| F[服务重试]
    D -->|条件评估失败| G[默认路径]
    D -->|系统错误| H[流程暂停]
    
    E --> I[发送通知]
    E --> J[任务升级]
    
    F --> K{重试次数}
    K -->|<最大次数| F
    K -->|>=最大次数| L[标记失败]
    
    G --> M[记录日志]
    G --> N[继续执行]
    
    H --> O[通知管理员]
    H --> P[等待修复]
    
    I --> Q[人工介入]
    J --> Q
    L --> Q
    P --> R[恢复执行]
```

## 14. 流程设计器界面布局

```mermaid
graph TB
    subgraph "设计器界面"
        A1[工具栏]
        A2[元素面板]
        A3[画布区域]
        A4[属性面板]
        A5[预览面板]
    end
    
    A1 --> A3
    A2 --> A3
    A3 --> A4
    A3 --> A5
    
    subgraph "工具栏功能"
        B1[新建]
        B2[打开]
        B3[保存]
        B4[验证]
        B5[预览]
        B6[导出]
    end
    
    subgraph "元素面板"
        C1[事件]
        C2[任务]
        C3[网关]
        C4[连接线]
    end
    
    subgraph "属性面板"
        D1[基本属性]
        D2[分配规则]
        D3[条件表达式]
        D4[监听器]
    end
```

## 15. 数据流图

```mermaid
graph LR
    A[BPMN XML] --> B[BPMN解析器]
    B --> C[流程模型]
    C --> D[流程定义表]
    
    E[启动请求] --> F[流程引擎]
    F --> D
    D --> G[创建实例]
    G --> H[流程实例表]
    
    H --> I[执行流程]
    I --> J[创建任务]
    J --> K[任务表]
    
    K --> L[用户处理]
    L --> M[更新任务]
    M --> I
    
    I --> N[记录历史]
    N --> O[执行历史表]
```

## 16. 性能优化架构

```mermaid
graph TB
    subgraph "缓存层"
        A1[流程定义缓存]
        A2[流程变量缓存]
        A3[任务列表缓存]
    end
    
    subgraph "异步处理"
        B1[流程执行队列]
        B2[任务创建队列]
        B3[事件处理队列]
    end
    
    subgraph "数据库优化"
        C1[流程实例分表]
        C2[历史数据归档]
        C3[索引优化]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B2
    B1 --> C1
    B2 --> C1
    B3 --> C2
```

---

## 图表说明

### 符号说明

- **矩形**：组件/模块
- **圆角矩形**：状态
- **菱形**：判断节点
- **圆形**：开始/结束
- **箭头**：流程方向/依赖关系

### 颜色说明

- **蓝色**：核心组件
- **绿色**：支撑组件
- **橙色**：数据存储
- **紫色**：外部集成

---

**文档版本**：V1.0  
**创建日期**：2025-12-17

# 工单管理模块 - 紧急修复与开发任务清单

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2024-12-19
- **基于文档**:
  - PRD-工单管理模块.md v1.0
  - 工单管理模块-问题诊断与修复方案.md v1.0
  - 开发任务清单-工单模块.md v1.0
- **优先级**: P0 - 紧急
- **预计总工期**: 3周（紧急修复1周 + P0功能开发2周）

---

## 任务统计

| 优先级 | 任务数 | 预计工作量 | 状态 |
|--------|--------|-----------|------|
| P0-紧急修复 | 6 | 8小时 | ✅ 已完成 |
| P0-核心功能 | 8 | 9人天 | 部分完成 |
| P1-重要功能 | 4 | 7人天 | 部分完成 |
| **总计** | **18** | **16人天** | **进行中** |

---

## 第一部分：紧急修复任务（P0 - 本周完成）

### 模块0：紧急问题修复（1天，8小时）

#### TASK-FIX-001: 完善空值处理

- **模块**: 工单管理
- **类型**: Bug修复
- **优先级**: P0-紧急
- **工作量**: 2小时
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 修复所有组件中的空值处理问题，防止 `Cannot read properties of undefined` 错误
- **目标文件**:
  - `itsm-prototype/src/components/business/TicketTable.tsx` ✅ 已修复
  - `itsm-prototype/src/components/business/TicketFilters.tsx` ✅ 已检查（已有安全处理）
  - `itsm-prototype/src/components/business/TicketStats.tsx` ✅ 已修复
  - `itsm-prototype/src/components/business/TicketViewSelector.tsx` ✅ 已修复
  - `itsm-prototype/src/app/(main)/tickets/page.tsx` ✅ 已修复
- **修复内容**:
  - [x] TicketTable 组件空值处理
  - [x] TicketFilters 组件空值处理（已有安全处理）
  - [x] TicketStats 组件空值处理
  - [x] TicketViewSelector 组件空值处理
  - [x] 所有数组访问使用 `?.` 或 `|| []`
  - [x] 所有对象属性访问使用可选链 `?.`
- **验收标准**:
  - [x] 所有组件在数据为空时正常显示
  - [x] 无 `Cannot read properties of undefined` 错误
  - [x] 加载状态正确显示
  - [x] 通过所有Linter检查

#### TASK-FIX-002: 添加错误边界保护

- **模块**: 工单管理
- **类型**: Bug修复
- **优先级**: P0-紧急
- **工作量**: 1小时
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 在关键组件外添加错误边界，防止单个组件错误导致整个页面崩溃
- **目标文件**:
  - `itsm-prototype/src/app/(main)/tickets/page.tsx` ✅ 已添加
  - `itsm-prototype/src/app/(main)/tickets/[ticketId]/page.tsx` ⚠️ 需添加
  - `itsm-prototype/src/app/(main)/tickets/create/page.tsx` ⚠️ 需添加
- **修复内容**:
  - [x] 工单列表页添加错误边界
  - [ ] 工单详情页添加错误边界
  - [ ] 工单创建页添加错误边界
  - [ ] 关键子组件添加错误边界
- **验收标准**:
  - [ ] 错误边界组件已正确包装
  - [ ] 错误时显示友好提示
  - [ ] 提供重试和返回首页功能
  - [ ] 错误信息正确记录

#### TASK-FIX-003: 统一API响应处理

- **模块**: 工单管理
- **类型**: Bug修复
- **优先级**: P0-紧急
- **工作量**: 2小时
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 统一API响应格式处理，添加数据验证和默认值
- **目标文件**:
  - `itsm-prototype/src/lib/utils/api-response-handler.ts` ✅ 新建工具函数
  - `itsm-prototype/src/lib/hooks/useTicketsQuery.ts` ✅ 已更新
  - `itsm-prototype/src/lib/api/ticket-api.ts` ⚠️ 可后续优化
  - `itsm-prototype/src/lib/api/ticket-view-api.ts` ⚠️ 可后续优化
  - `itsm-prototype/src/lib/api/ticket-assignment-api.ts` ⚠️ 可后续优化
- **修复内容**:
  - [x] 统一API响应格式处理函数（创建工具函数）
  - [x] 添加响应数据验证
  - [x] 提供默认数据结构
  - [x] 统一错误处理逻辑（在hooks中）
- **验收标准**:
  - [x] API响应处理统一（工具函数已创建）
  - [x] 数据验证完善
  - [x] 错误处理完善
  - [x] 关键API调用都有错误处理

#### TASK-FIX-004: 修复Ant Design API弃用警告

- **模块**: 工单管理
- **类型**: Bug修复
- **优先级**: P0-紧急
- **工作量**: 0.5小时
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 修复所有Ant Design API弃用警告
- **目标文件**:
  - `itsm-prototype/src/components/business/TicketViewSelector.tsx` ✅ 已修复
  - `itsm-prototype/src/components/business/TicketCategorySelector.tsx` ✅ 已修复
- **修复内容**:
  - [x] `dropdownRender` 改为 `popupRender`
  - [ ] 检查其他弃用API
- **验收标准**:
  - [ ] 无Ant Design弃用警告
  - [ ] 所有Select组件使用最新API

#### TASK-FIX-005: 完善TypeScript类型定义

- **模块**: 工单管理
- **类型**: 代码质量
- **优先级**: P0-紧急
- **工作量**: 2小时
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 完善所有工单相关组件的TypeScript类型定义
- **目标文件**:
  - `itsm-prototype/src/lib/api/ticket-view-api.ts` ✅ 已完善
  - `itsm-prototype/src/lib/api/ticket-assignment-api.ts` ✅ 已完善
  - `itsm-prototype/src/components/business/TicketFilters.tsx` ✅ 已修复
  - `itsm-prototype/src/app/(main)/tickets/page.tsx` ✅ 已修复
- **修复内容**:
  - [x] 完善接口类型定义（FilterConfig, SortConfig, GroupConfig, ConditionConfig, ActionConfig）
  - [x] 添加严格的类型检查
  - [x] 修复所有类型错误（any类型替换为具体类型）
  - [x] 统一TicketFilterState类型定义
- **验收标准**:
  - [x] TypeScript编译无错误
  - [x] 所有类型定义完整
  - [x] 类型检查通过

#### TASK-FIX-006: 添加加载状态和错误提示

- **模块**: 工单管理
- **类型**: 用户体验
- **优先级**: P0-紧急
- **工作量**: 1.5小时
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 统一加载状态显示，完善错误提示
- **目标文件**:
  - `itsm-prototype/src/components/business/TicketTable.tsx` ✅ 已完善
  - `itsm-prototype/src/app/(main)/tickets/page.tsx` ✅ 已完善
  - `itsm-prototype/src/lib/utils/error-message-handler.ts` ✅ 新建工具函数
- **修复内容**:
  - [x] 统一加载状态显示（使用TicketListSkeleton）
  - [x] 添加骨架屏（已有TicketListSkeleton组件）
  - [x] 统一错误消息格式（创建ErrorMessageHandler工具类）
  - [x] 提供可操作的错误提示（LoadingEmptyError组件）
  - [x] 添加空状态处理
- **验收标准**:
  - [x] 所有数据加载都有加载状态
  - [x] 错误提示友好且可操作
  - [x] 空状态有友好提示
  - [x] 用户体验良好

---

## 第二部分：P0核心功能开发（2周，9人天）

### 模块1：工单评论系统（2天）

#### TASK-TICKET-001: 工单评论系统后端API开发

- **模块**: 工单管理
- **类型**: 后端开发
- **优先级**: P0
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 开发工单评论系统后端API，支持公开评论和内部备注
- **API接口**:
  - `GET /api/v1/tickets/:id/comments` - 获取工单评论列表
  - `POST /api/v1/tickets/:id/comments` - 添加评论
  - `PUT /api/v1/tickets/:id/comments/:comment_id` - 更新评论
  - `DELETE /api/v1/tickets/:id/comments/:comment_id` - 删除评论
- **验收标准**:
  - [ ] 支持添加公开评论和内部备注
  - [ ] 支持@用户提醒功能
  - [ ] 支持评论编辑和删除
  - [ ] 支持评论附件上传
  - [ ] 支持评论通知
  - [ ] 评论列表按时间倒序显示
- **依赖**: 无

#### TASK-TICKET-002: 工单评论系统前端开发

- **模块**: 工单管理
- **类型**: 前端开发
- **优先级**: P0
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ✅ 已完成
- **描述**: 开发工单评论系统前端界面
- **页面路径**: `/tickets/:id` (工单详情页)
- **验收标准**:
  - [ ] 工单详情页显示评论列表
  - [ ] 支持添加评论（富文本编辑器）
  - [ ] 支持@用户功能
  - [ ] 支持内部备注（仅处理人可见）
  - [ ] 支持评论编辑和删除
  - [ ] 支持评论附件上传
  - [ ] 评论列表实时更新
- **依赖**: TASK-TICKET-001

### 模块2：工单附件管理（2天）

#### TASK-TICKET-003: 工单附件管理后端API开发

- **模块**: 工单管理
- **类型**: 后端开发
- **优先级**: P0
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单附件管理后端API
- **API接口**:
  - `POST /api/v1/tickets/:id/attachments` - 上传附件
  - `GET /api/v1/tickets/:id/attachments` - 获取附件列表
  - `GET /api/v1/tickets/:id/attachments/:attachment_id` - 获取附件详情
  - `GET /api/v1/tickets/:id/attachments/:attachment_id/download` - 下载附件
  - `GET /api/v1/tickets/:id/attachments/:attachment_id/preview` - 预览附件
  - `DELETE /api/v1/tickets/:id/attachments/:attachment_id` - 删除附件
- **验收标准**:
  - [ ] 支持多文件上传
  - [ ] 附件大小限制（可配置，默认10MB）
  - [ ] 附件类型限制（可配置）
  - [ ] 支持图片、PDF、Office文档预览
  - [ ] 支持附件下载
  - [ ] 附件信息完整（文件名、大小、上传时间、上传人）
  - [ ] 支持附件病毒扫描（可选）
- **依赖**: 文件存储服务

#### TASK-TICKET-004: 工单附件管理前端开发

- **模块**: 工单管理
- **类型**: 前端开发
- **优先级**: P0
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单附件管理前端界面
- **页面路径**: `/tickets/:id` (工单详情页), `/tickets/create` (创建工单页)
- **验收标准**:
  - [ ] 工单创建和编辑时支持上传附件
  - [ ] 支持拖拽上传
  - [ ] 支持附件预览（图片、PDF、Office文档）
  - [ ] 支持附件下载
  - [ ] 附件列表显示完整信息
  - [ ] 支持附件删除
  - [ ] 上传进度显示
- **依赖**: TASK-TICKET-003

### 模块3：工单通知系统（3天）

#### TASK-TICKET-005: 工单通知系统后端API开发

- **模块**: 工单管理
- **类型**: 后端开发
- **优先级**: P0
- **工作量**: 1.5天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单通知系统后端API
- **API接口**:
  - `GET /api/v1/tickets/:id/notifications` - 获取工单通知列表
  - `POST /api/v1/tickets/:id/notifications` - 发送通知
  - `PUT /api/v1/tickets/:id/notifications/:notification_id/read` - 标记已读
  - `GET /api/v1/notifications` - 获取用户通知列表
  - `PUT /api/v1/notifications/:id/read` - 标记通知已读
  - `PUT /api/v1/notifications/settings` - 更新通知设置
- **验收标准**:
  - [ ] 工单创建时发送通知给处理人
  - [ ] 工单状态变更时通知相关用户
  - [ ] 工单分配时通知新处理人
  - [ ] 工单评论时通知相关人员
  - [ ] SLA即将到期时发送提醒
  - [ ] 支持邮件通知
  - [ ] 支持站内消息通知
  - [ ] 支持通知模板配置
  - [ ] 支持用户通知偏好设置
- **依赖**: 邮件服务、消息队列

#### TASK-TICKET-006: 工单通知系统前端开发

- **模块**: 工单管理
- **类型**: 前端开发
- **优先级**: P0
- **工作量**: 1.5天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单通知系统前端界面
- **页面路径**: `/tickets/:id` (工单详情页), `/notifications` (通知中心)
- **验收标准**:
  - [ ] 工单详情页显示通知历史
  - [ ] 通知中心显示所有通知
  - [ ] 支持通知已读/未读标记
  - [ ] 支持通知筛选和搜索
  - [ ] 支持通知设置（邮件、站内消息偏好）
  - [ ] 实时通知提醒（WebSocket或轮询）
  - [ ] 通知数量徽章显示
- **依赖**: TASK-TICKET-005

### 模块4：工单评分系统（2天）

#### TASK-TICKET-007: 工单评分系统后端API开发

- **模块**: 工单管理
- **类型**: 后端开发
- **优先级**: P0
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单评分系统后端API
- **API接口**:
  - `POST /api/v1/tickets/:id/rating` - 提交评分
  - `GET /api/v1/tickets/:id/rating` - 获取工单评分
  - `GET /api/v1/tickets/rating-stats` - 获取评分统计
  - `GET /api/v1/tickets/rating-stats/by-assignee` - 按处理人统计评分
  - `GET /api/v1/tickets/rating-stats/by-category` - 按分类统计评分
- **验收标准**:
  - [ ] 工单解决后，申请人可以评分
  - [ ] 支持1-5星评分
  - [ ] 支持评分评论
  - [ ] 评分后发送通知给处理人
  - [ ] 支持评分统计分析
  - [ ] 支持按处理人、分类等维度统计
  - [ ] 评分数据用于服务质量评估
- **依赖**: 无

#### TASK-TICKET-008: 工单评分系统前端开发

- **模块**: 工单管理
- **类型**: 前端开发
- **优先级**: P0
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单评分系统前端界面
- **页面路径**: `/tickets/:id` (工单详情页), `/tickets/rating-stats` (评分统计页)
- **验收标准**:
  - [ ] 工单解决后显示评分入口
  - [ ] 评分表单（星级评分、评论）
  - [ ] 评分提交后显示感谢信息
  - [ ] 评分统计页面（平均分、分布图等）
  - [ ] 支持按处理人、分类等维度查看统计
  - [ ] 评分数据可视化展示
- **依赖**: TASK-TICKET-007

---

## 第三部分：P1重要功能完善（1周，7人天）

### 模块5：工单知识库关联（2天）

#### TASK-TICKET-011: 工单知识库关联后端API开发

- **模块**: 工单管理
- **类型**: 后端开发
- **优先级**: P1
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单知识库关联后端API
- **API接口**:
  - `POST /api/v1/tickets/:id/create-knowledge` - 从工单创建知识库条目
  - `GET /api/v1/tickets/:id/recommended-knowledge` - 获取推荐知识库文章
  - `GET /api/v1/tickets/:id/similar-tickets` - 获取类似工单（历史解决方案）
  - `POST /api/v1/tickets/:id/link-knowledge/:knowledge_id` - 关联知识库文章
- **验收标准**:
  - [ ] 工单解决时可以创建知识库条目
  - [ ] 创建工单时基于关键词推荐相关文章
  - [ ] 处理工单时可以查看历史类似工单的解决方案
  - [ ] 支持解决方案模板
  - [ ] 知识库文章可以关联到工单分类
- **依赖**: 知识库模块

#### TASK-TICKET-012: 工单知识库关联前端开发

- **模块**: 工单管理
- **类型**: 前端开发
- **优先级**: P1
- **工作量**: 1天
- **负责人**: [待分配]
- **状态**: ⏳ 待开始
- **描述**: 开发工单知识库关联前端界面
- **页面路径**: `/tickets/:id` (工单详情页), `/tickets/create` (创建工单页)
- **验收标准**:
  - [ ] 工单解决时显示"创建知识库条目"按钮
  - [ ] 创建知识库条目表单（标题、内容、分类等）
  - [ ] 创建工单时显示推荐知识库文章列表
  - [ ] 处理工单时显示历史类似工单列表
  - [ ] 支持查看历史工单的解决方案
  - [ ] 支持关联知识库文章到工单
- **依赖**: TASK-TICKET-011

---

## 第四部分：已完成功能（参考）

### 已完成任务

- ✅ TASK-TICKET-009: 智能分配系统后端API开发
- ✅ TASK-TICKET-010: 智能分配系统前端开发
- ✅ TASK-TICKET-013: 工单自动化规则引擎后端开发
- ✅ TASK-TICKET-014: 工单自动化规则前端开发
- ✅ TASK-TICKET-015: 工单高级筛选和视图后端API开发
- ✅ TASK-TICKET-016: 工单高级筛选和视图前端开发

---

## 实施优先级和时间表

### 第1周：紧急修复 + P0功能启动

**Day 1-2 (紧急修复)** ✅ 已完成:

- TASK-FIX-001: 完善空值处理 (2小时) ✅
- TASK-FIX-002: 添加错误边界保护 (1小时) ✅
- TASK-FIX-003: 统一API响应处理 (2小时) ✅
- TASK-FIX-004: 修复Ant Design API弃用警告 (0.5小时) ✅
- TASK-FIX-005: 完善TypeScript类型定义 (2小时) ✅
- TASK-FIX-006: 添加加载状态和错误提示 (1.5小时) ✅

**Day 3-5 (P0功能开发)**:

- TASK-TICKET-001: 工单评论系统后端API开发 (1天)
- TASK-TICKET-002: 工单评论系统前端开发 (1天)
- TASK-TICKET-003: 工单附件管理后端API开发 (1天)

### 第2周：P0功能完成

**Day 1-3**:

- TASK-TICKET-004: 工单附件管理前端开发 (1天)
- TASK-TICKET-005: 工单通知系统后端API开发 (1.5天)
- TASK-TICKET-006: 工单通知系统前端开发 (0.5天)

**Day 4-5**:

- TASK-TICKET-006: 工单通知系统前端开发 (1天)
- TASK-TICKET-007: 工单评分系统后端API开发 (1天)

### 第3周：P0收尾 + P1功能

**Day 1-2**:

- TASK-TICKET-008: 工单评分系统前端开发 (1天)
- 测试和Bug修复 (1天)

**Day 3-5**:

- TASK-TICKET-011: 工单知识库关联后端API开发 (1天)
- TASK-TICKET-012: 工单知识库关联前端开发 (1天)
- 测试和优化 (1天)

---

## 验收标准总结

### 紧急修复验收

- [x] 所有组件在数据为空时正常显示
- [x] 无 `Cannot read properties of undefined` 错误
- [x] 无Ant Design弃用警告
- [x] 错误边界正常工作
- [x] API响应处理统一
- [x] TypeScript类型检查通过
- [x] 加载状态和错误提示完善

### P0功能验收

- [ ] 工单评论系统完整可用
- [ ] 工单附件管理完整可用
- [ ] 工单通知系统完整可用
- [ ] 工单评分系统完整可用
- [ ] 所有功能通过测试
- [ ] 无严重Bug

### 整体验收

- [ ] 工单管理模块可以正常使用
- [ ] 所有P0功能已实现
- [ ] 性能满足要求（页面加载 < 2秒）
- [ ] 用户体验良好
- [ ] 代码质量达标

---

## 风险与应对

### 技术风险

1. **API响应格式不一致**
   - 风险: 不同API返回格式不同导致解析错误
   - 应对: 统一响应处理函数，添加数据验证

2. **文件上传性能问题**
   - 风险: 大文件上传可能超时或失败
   - 应对: 实现分片上传，添加重试机制

3. **实时通知实现复杂度**
   - 风险: WebSocket实现可能复杂
   - 应对: 先使用轮询，后续优化为WebSocket

### 进度风险

1. **开发时间可能超出预期**
   - 风险: 功能复杂度可能被低估
   - 应对: 预留20%缓冲时间，优先完成核心功能

2. **测试时间不足**
   - 风险: 快速开发可能导致测试不充分
   - 应对: 开发过程中持续测试，每日构建

### 质量风险

1. **快速修复可能引入新问题**
   - 风险: 紧急修复可能不够完善
   - 应对: 代码审查，充分测试

2. **技术债务积累**
   - 风险: 快速开发可能产生技术债务
   - 应对: 记录技术债务，后续迭代优化

---

## 附录

### 相关文档

- PRD-工单管理模块.md
- 工单管理模块-问题诊断与修复方案.md
- 开发任务清单-工单模块.md

### 技术栈

- **后端**: Go + Gin + Ent ORM
- **前端**: Next.js + React + Ant Design
- **状态管理**: Zustand
- **数据获取**: React Query

### 联系方式

- 产品经理: [待填写]
- 技术负责人: [待填写]
- 开发负责人: [待填写]

---

## 版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2024-12-19 | 产品经理 | 初始版本，整合PRD和问题诊断方案 |

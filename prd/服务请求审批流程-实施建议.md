# 服务请求审批流程 - 快速实施建议

## 一、当前系统分析

### ✅ 已有功能

1. **基础审批流程**：三段式审批（主管→IT→安全）
2. **审批记录**：ServiceRequestApproval 表存储审批记录
3. **审批操作**：支持通过/拒绝操作
4. **权限控制**：基于角色的审批权限校验

### ⚠️ 需要改进的点

1. **流程固化**：当前流程是硬编码的三段式，不够灵活
2. **缺少配置**：无法根据不同服务类型配置不同审批流程
3. **超时处理**：没有审批超时自动处理机制
4. **通知机制**：通知功能可能不完善
5. **条件审批**：不支持根据条件动态调整审批路径

## 二、分阶段实施建议

### 阶段一：优化现有功能（1-2周）

#### 1.1 增强审批记录表

在 `ServiceRequestApproval` 表中添加：

- `timeout_hours`：审批时限
- `due_at`：到期时间（自动计算）
- `is_escalated`：是否已升级

#### 1.2 完善通知机制

- 审批待办通知
- 审批通过/拒绝通知
- 超时提醒通知

#### 1.3 优化审批体验

- 审批历史时间线展示
- 审批进度可视化
- 审批意见必填（拒绝时）

### 阶段二：流程配置化（2-3周）

#### 2.1 创建审批配置表

```sql
CREATE TABLE service_request_approval_config (
    id SERIAL PRIMARY KEY,
    catalog_id INTEGER NOT NULL,
    workflow_type VARCHAR(50),  -- standard/simplified/fast
    nodes JSONB,  -- 审批节点配置
    conditions JSONB,  -- 条件规则
    is_active BOOLEAN DEFAULT true,
    tenant_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.2 实现动态流程计算

- 根据服务目录获取审批配置
- 根据申请属性（公网IP、数据分级等）调整节点
- 动态创建审批记录

#### 2.3 管理界面

- 审批流程配置页面
- 支持可视化配置审批节点
- 支持条件规则配置

### 阶段三：高级功能（3-4周）

#### 3.1 超时处理

- 定时任务检查超时审批
- 自动发送提醒
- 自动升级机制

#### 3.2 并行审批

- 支持多人会签
- 支持任意一人通过

#### 3.3 代理审批

- 设置代理审批人
- 临时转交审批

## 三、快速改进方案（立即可做）

### 改进1：审批时限提醒

在创建审批记录时计算到期时间，并在前端显示倒计时。

**实现步骤**：

1. 在 `ServiceRequestApproval` 添加 `due_at` 字段
2. 创建审批记录时计算：`due_at = created_at + timeout_hours`
3. 前端显示剩余时间

### 改进2：审批历史展示

在服务请求详情页展示完整的审批时间线。

**实现步骤**：

1. 查询所有审批记录（按level排序）
2. 展示每个节点的状态、审批人、时间、意见
3. 用时间线组件展示

### 改进3：审批意见必填

拒绝时必须填写审批意见。

**实现步骤**：

1. 前端校验：拒绝时意见不能为空
2. 后端校验：拒绝时comment必填

### 改进4：审批进度可视化

在服务请求列表和详情页显示审批进度条。

**实现步骤**：

1. 计算进度：`progress = (current_level - 1) / total_levels * 100`
2. 显示进度条组件
3. 显示当前审批节点名称

## 四、数据库迁移建议

### 迁移1：扩展审批记录表

```sql
-- 添加新字段
ALTER TABLE service_request_approval 
ADD COLUMN timeout_hours INTEGER DEFAULT 24,
ADD COLUMN due_at TIMESTAMP,
ADD COLUMN is_escalated BOOLEAN DEFAULT false,
ADD COLUMN delegated_to_id INTEGER,
ADD COLUMN escalation_reason TEXT;

-- 创建索引
CREATE INDEX idx_sr_approval_due_at ON service_request_approval(due_at) 
WHERE status = 'pending';
```

### 迁移2：创建审批配置表

```sql
CREATE TABLE service_request_approval_config (
    id SERIAL PRIMARY KEY,
    catalog_id INTEGER NOT NULL,
    workflow_type VARCHAR(50) NOT NULL DEFAULT 'standard',
    nodes JSONB NOT NULL DEFAULT '[]',
    conditions JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    tenant_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(catalog_id, tenant_id)
);

CREATE INDEX idx_sr_approval_config_catalog ON service_request_approval_config(catalog_id, tenant_id);
```

### 迁移3：创建审批历史表（可选，用于审计）

```sql
CREATE TABLE service_request_approval_history (
    id SERIAL PRIMARY KEY,
    service_request_id INTEGER NOT NULL,
    approval_id INTEGER NOT NULL,
    action VARCHAR(50) NOT NULL,  -- approve/reject/delegate/timeout/escalate
    actor_id INTEGER NOT NULL,
    actor_name VARCHAR(255) NOT NULL,
    comment TEXT,
    previous_status VARCHAR(50),
    new_status VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_sr_approval_history_request ON service_request_approval_history(service_request_id);
CREATE INDEX idx_sr_approval_history_approval ON service_request_approval_history(approval_id);
```

## 五、API接口扩展建议

### 5.1 获取审批配置

```
GET /api/v1/service-requests/approval-configs?catalog_id={id}
```

### 5.2 更新审批配置

```
PUT /api/v1/service-requests/approval-configs/{id}
```

### 5.3 转交审批

```
POST /api/v1/service-requests/{id}/delegate
Body: {
  "delegated_to_id": 123,
  "comment": "转交给XXX审批"
}
```

### 5.4 获取审批统计

```
GET /api/v1/service-requests/approval-stats
Response: {
  "pending_count": 10,
  "timeout_count": 2,
  "avg_approval_time": 36.5  // 小时
}
```

## 六、前端组件建议

### 6.1 审批进度组件

```tsx
<ApprovalProgress 
  currentLevel={2} 
  totalLevels={3}
  approvals={approvals}
/>
```

### 6.2 审批时间线组件

```tsx
<ApprovalTimeline approvals={approvals} />
```

### 6.3 审批操作组件

```tsx
<ApprovalActions 
  requestId={id}
  onApprove={handleApprove}
  onReject={handleReject}
  onDelegate={handleDelegate}
/>
```

### 6.4 审批配置表单

```tsx
<ApprovalConfigForm 
  catalogId={catalogId}
  config={config}
  onSave={handleSave}
/>
```

## 七、测试建议

### 7.1 单元测试

- 审批流程计算逻辑
- 权限校验逻辑
- 状态转换逻辑

### 7.2 集成测试

- 完整审批流程测试
- 超时处理测试
- 通知发送测试

### 7.3 用户验收测试

- 不同角色的审批流程
- 各种边界场景
- 异常情况处理

## 八、上线检查清单

- [ ] 数据库迁移脚本已执行
- [ ] 审批流程配置已初始化
- [ ] 通知功能已测试
- [ ] 权限控制已验证
- [ ] 前端页面已更新
- [ ] 用户文档已更新
- [ ] 监控告警已配置
- [ ] 回滚方案已准备

## 九、后续优化方向

1. **智能审批**：基于历史数据推荐审批人
2. **移动审批**：支持移动端快速审批
3. **审批分析**：审批效率分析报表
4. **流程优化**：基于数据分析优化审批流程
5. **自动化**：低风险申请自动审批

---

**建议优先级**：

1. 🔴 **高优先级**：阶段一的改进（1-2周）
2. 🟡 **中优先级**：阶段二的配置化（2-3周）
3. 🟢 **低优先级**：阶段三的高级功能（3-4周）

**预计总工期**：6-9周（可根据资源情况调整）

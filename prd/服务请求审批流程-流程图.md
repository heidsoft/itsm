# 服务请求审批流程 - 流程图

## 1. 标准审批流程（三段式）

```mermaid
graph TD
    A[用户提交服务请求] --> B{判断审批流程类型}
    B -->|标准流程| C[创建三段审批记录]
    C --> D[通知部门主管审批]
    D --> E{主管审批}
    E -->|通过| F[状态: manager_approved]
    E -->|拒绝| G[状态: rejected]
    E -->|超时| H[自动升级/提醒]
    F --> I[通知IT人员审批]
    I --> J{IT审批}
    J -->|通过| K[状态: it_approved]
    J -->|拒绝| G
    J -->|超时| H
    K --> L{是否需要安全审批?}
    L -->|是| M[通知安全人员审批]
    L -->|否| N[状态: approved]
    M --> O{安全审批}
    O -->|通过| N
    O -->|拒绝| G
    O -->|超时| H
    N --> P[触发资源交付]
    P --> Q[状态: delivered]
    G --> R[通知申请人]
    H --> S[处理超时]
```

## 2. 条件审批流程（动态）

```mermaid
graph TD
    A[用户提交服务请求] --> B[读取服务目录配置]
    B --> C{判断审批条件}
    C -->|需要公网IP| D[添加安全审批节点]
    C -->|成本>阈值| E[添加财务审批节点]
    C -->|数据分级=confidential| D
    C -->|申请人=manager| F[跳过主管审批]
    D --> G[生成审批路径]
    E --> G
    F --> G
    G --> H[创建审批记录]
    H --> I[开始审批流程]
```

## 3. 审批状态流转图

```mermaid
stateDiagram-v2
    [*] --> draft: 创建草稿
    draft --> submitted: 提交申请
    submitted --> pending_approval: 进入审批
    pending_approval --> manager_approved: 主管通过
    pending_approval --> rejected: 任意节点拒绝
    manager_approved --> it_approved: IT通过
    manager_approved --> rejected: IT拒绝
    it_approved --> security_approved: 安全通过(如需要)
    it_approved --> approved: 无需安全审批
    security_approved --> approved: 全部通过
    approved --> provisioning: 开始交付
    provisioning --> delivered: 交付完成
    rejected --> cancelled: 取消
    pending_approval --> cancelled: 申请人取消
    manager_approved --> cancelled: 申请人取消
    it_approved --> cancelled: 申请人取消
    security_approved --> cancelled: 申请人取消
    cancelled --> [*]
    delivered --> [*]
```

## 4. 审批节点详细流程

```mermaid
sequenceDiagram
    participant U as 申请人
    participant S as 系统
    participant M as 部门主管
    participant I as IT人员
    participant Sec as 安全人员
    
    U->>S: 提交服务请求
    S->>S: 创建审批记录
    S->>M: 发送审批通知
    M->>S: 查看申请详情
    M->>S: 审批通过/拒绝
    alt 审批通过
        S->>I: 发送IT审批通知
        I->>S: 查看申请详情
        I->>S: 审批通过/拒绝
        alt IT审批通过
            alt 需要安全审批
                S->>Sec: 发送安全审批通知
                Sec->>S: 查看申请详情
                Sec->>S: 审批通过/拒绝
                alt 安全审批通过
                    S->>U: 通知全部通过
                    S->>S: 触发资源交付
                else 安全审批拒绝
                    S->>U: 通知被拒绝
                end
            else 无需安全审批
                S->>U: 通知全部通过
                S->>S: 触发资源交付
            end
        else IT审批拒绝
            S->>U: 通知被拒绝
        end
    else 审批拒绝
        S->>U: 通知被拒绝
    end
```

## 5. 超时处理流程

```mermaid
graph TD
    A[定时任务启动] --> B[查询超时审批]
    B --> C{是否超时?}
    C -->|否| D[跳过]
    C -->|是| E{超时时长}
    E -->|2小时内| F[发送提醒通知]
    E -->|已超时| G[发送警告通知]
    E -->|超时24小时| H[自动升级]
    E -->|超时72小时| I{配置策略}
    I -->|自动通过| J[自动通过]
    I -->|自动拒绝| K[自动拒绝]
    I -->|人工介入| L[通知管理员]
    F --> M[更新提醒记录]
    G --> M
    H --> N[通知上级审批人]
    J --> O[更新审批状态]
    K --> O
    L --> P[等待人工处理]
```

## 6. 并行审批流程

```mermaid
graph TD
    A[到达并行审批节点] --> B[创建多个审批任务]
    B --> C[通知所有审批人]
    C --> D[审批人1]
    C --> E[审批人2]
    C --> F[审批人3]
    D --> G{审批结果}
    E --> G
    F --> G
    G -->|全部通过| H[节点通过]
    G -->|任意拒绝| I[节点拒绝]
    G -->|部分通过| J{等待剩余审批}
    J -->|超时| K{超时策略}
    K -->|全部通过才通过| I
    K -->|任意通过即通过| H
```

## 7. 代理审批流程

```mermaid
graph TD
    A[审批人不在岗] --> B{设置代理}
    B -->|已设置代理| C[自动转交给代理]
    B -->|未设置代理| D[手动转交]
    C --> E[通知代理审批人]
    D --> E
    E --> F[代理审批]
    F --> G[记录代理关系]
    G --> H[更新审批记录]
    H --> I[通知原审批人]
```

## 8. 审批配置管理流程

```mermaid
graph TD
    A[管理员配置审批流程] --> B[选择服务目录]
    B --> C[选择流程类型]
    C --> D{流程类型}
    D -->|标准| E[配置标准节点]
    D -->|简化| F[配置简化节点]
    D -->|快速| G[配置快速节点]
    D -->|条件| H[配置条件规则]
    E --> I[设置节点属性]
    F --> I
    G --> I
    H --> J[配置条件表达式]
    J --> I
    I --> K[保存配置]
    K --> L[应用到服务目录]
    L --> M[新申请使用新配置]
```

## 9. 审批数据分析流程

```mermaid
graph TD
    A[收集审批数据] --> B[计算指标]
    B --> C[平均审批时长]
    B --> D[审批通过率]
    B --> E[超时率]
    B --> F[各节点耗时]
    C --> G[生成报表]
    D --> G
    E --> G
    F --> G
    G --> H[识别瓶颈]
    H --> I[优化建议]
    I --> J[更新审批配置]
```

## 10. 完整审批生命周期

```mermaid
gantt
    title 服务请求审批生命周期
    dateFormat  YYYY-MM-DD
    section 申请阶段
    创建申请           :a1, 2025-12-17, 1d
    提交申请           :a2, after a1, 1d
    section 审批阶段
    主管审批           :b1, after a2, 2d
    IT审批             :b2, after b1, 2d
    安全审批           :b3, after b2, 3d
    section 交付阶段
    资源交付           :c1, after b3, 5d
    交付完成           :c2, after c1, 1d
```

---

## 流程图说明

### 符号说明

- **矩形**：处理步骤
- **菱形**：判断节点
- **圆角矩形**：开始/结束
- **箭头**：流程方向

### 关键决策点

1. **审批流程类型判断**：根据服务目录配置决定
2. **是否需要安全审批**：根据申请属性判断
3. **审批结果**：通过/拒绝/超时
4. **超时处理策略**：提醒/升级/自动处理

### 异常处理

- 所有审批节点都可能超时
- 任意节点拒绝都会终止流程
- 支持申请人主动取消
- 支持审批人转交

---

**文档版本**：V1.0  
**创建日期**：2025-12-17

# 服务请求审批流程设计文档

## 1. 流程概述

### 1.1 设计目标

- **合规性**：确保服务请求符合企业安全、成本、合规要求
- **效率性**：减少人工干预，提高审批效率
- **灵活性**：支持不同服务类型、不同场景的审批流程配置
- **可追溯性**：完整记录审批过程，便于审计和问题追溯

### 1.2 适用范围

- 云资源申请（计算、存储、网络）
- 系统访问权限申请
- 数据访问权限申请
- 软件/工具申请
- 其他需要审批的IT服务请求

## 2. 审批流程架构

### 2.1 流程类型

#### 2.1.1 标准审批流程（三段式）

```
提交 → 部门主管审批 → IT审批 → 安全审批 → 完成
```

**适用场景**：

- 需要公网访问的资源
- 涉及敏感数据的服务
- 高成本服务（超过阈值）

#### 2.1.2 简化审批流程（两段式）

```
提交 → 部门主管审批 → IT审批 → 完成
```

**适用场景**：

- 内部服务申请
- 低风险服务
- 标准配置服务

#### 2.1.3 快速审批流程（一段式）

```
提交 → IT审批 → 完成
```

**适用场景**：

- 紧急服务请求
- 低价值服务
- 预审批服务

#### 2.1.4 条件审批流程（动态）

根据服务属性、申请人角色、成本等因素动态决定审批路径。

## 3. 审批节点设计

### 3.1 节点类型

#### 3.1.1 部门主管审批节点

**职责**：

- 确认业务合理性
- 确认成本归属
- 确认资源使用期限

**审批人确定规则**：

- 申请人所在部门的部门主管（role=manager）
- 同部门匹配
- 支持代理审批（主管不在时）

**审批时限**：

- 标准：24小时
- 紧急：4小时
- 超时处理：自动升级或通知上级

#### 3.1.2 IT审批节点

**职责**：

- 技术可行性评估
- 资源配置合理性
- 与现有系统兼容性

**审批人确定规则**：

- IT部门的技术人员（role=agent/technician）
- 根据服务类型分配给对应专家
- 支持多人会签（并行审批）

**审批时限**：

- 标准：48小时
- 紧急：8小时

#### 3.1.3 安全审批节点

**职责**：

- 安全风险评估
- 合规性检查
- 数据分级确认

**审批人确定规则**：

- 安全部门人员（role=security）
- 仅当涉及公网访问或敏感数据时触发

**审批时限**：

- 标准：72小时
- 紧急：24小时

### 3.2 审批方式

#### 3.2.1 串行审批（Sequential）

按顺序依次审批，前一个节点通过后才能进入下一个节点。

**适用场景**：标准审批流程

#### 3.2.2 并行审批（Parallel）

多个审批人同时审批，全部通过才算通过。

**适用场景**：

- IT部门多人会签
- 跨部门联合审批

#### 3.2.3 会签审批（Any One）

多个审批人中任意一人通过即可。

**适用场景**：

- 紧急情况
- 备选审批人

#### 3.2.4 条件审批（Conditional）

根据条件决定是否需要该节点。

**条件示例**：

- 成本 > 10万 → 需要财务审批
- 涉及公网IP → 需要安全审批
- 数据分级 = confidential → 需要安全审批

## 4. 状态流转设计

### 4.1 服务请求状态

```
draft（草稿）
  ↓
submitted（已提交）
  ↓
pending_approval（审批中）
  ├─→ manager_approved（主管已审批）
  │     ↓
  │   it_approved（IT已审批）
  │     ↓
  │   security_approved（安全已审批）
  │     ↓
  │   approved（全部审批通过）
  │     ↓
  │   provisioning（资源交付中）
  │     ↓
  │   delivered（已交付）
  │
  └─→ rejected（已拒绝）
        ↓
      cancelled（已取消）
```

### 4.2 审批记录状态

```
pending（待审批）
  ├─→ approved（已通过）
  ├─→ rejected（已拒绝）
  ├─→ delegated（已转交）
  └─→ timeout（已超时）
```

### 4.3 状态转换规则

| 当前状态 | 允许转换到 | 触发条件 |
|---------|----------|---------|
| draft | submitted | 用户提交 |
| submitted | pending_approval | 系统自动进入审批流程 |
| pending_approval | manager_approved | 主管审批通过 |
| manager_approved | it_approved | IT审批通过 |
| it_approved | security_approved | 安全审批通过（如需要） |
| security_approved | approved | 所有审批通过 |
| approved | provisioning | 开始资源交付 |
| provisioning | delivered | 资源交付完成 |
| * | rejected | 任意节点拒绝 |
| * | cancelled | 申请人取消或系统自动取消 |

## 5. 审批规则配置

### 5.1 规则引擎设计

#### 5.1.1 基于服务目录的规则

```json
{
  "catalog_id": 1,
  "catalog_name": "云服务器申请",
  "approval_workflow": {
    "type": "standard",  // standard/simplified/fast/conditional
    "nodes": [
      {
        "step": "manager",
        "required": true,
        "timeout_hours": 24,
        "auto_escalate": true
      },
      {
        "step": "it",
        "required": true,
        "timeout_hours": 48,
        "parallel": false,
        "assignee_rules": {
          "role": ["agent", "technician"],
          "department": "IT"
        }
      },
      {
        "step": "security",
        "required": false,
        "conditions": [
          {
            "field": "needs_public_ip",
            "operator": "equals",
            "value": true
          },
          {
            "field": "data_classification",
            "operator": "in",
            "value": ["confidential"]
          }
        ],
        "timeout_hours": 72
      }
    ]
  }
}
```

#### 5.1.2 基于成本的规则

```json
{
  "cost_threshold": 100000,
  "additional_approval": {
    "step": "finance",
    "required": true,
    "timeout_hours": 48
  }
}
```

#### 5.1.3 基于申请人的规则

```json
{
  "requester_rules": {
    "role": "manager",
    "bypass_manager_approval": true,
    "direct_to_it": true
  }
}
```

### 5.2 动态审批路径计算

**算法逻辑**：

1. 获取服务目录的默认审批流程
2. 根据服务请求属性（成本、公网IP、数据分级等）调整节点
3. 根据申请人角色/级别调整节点
4. 生成最终审批路径
5. 创建审批记录

## 6. 特殊场景处理

### 6.1 紧急审批

**触发条件**：

- 申请人标记为紧急
- 优先级为high/critical

**处理方式**：

- 缩短审批时限（标准时限的1/4）
- 自动通知所有审批人
- 超时自动升级
- 支持移动端快速审批

### 6.2 代理审批

**场景**：

- 审批人不在岗
- 审批人请假
- 审批人离职

**处理方式**：

- 支持设置代理审批人
- 支持临时转交审批
- 记录代理审批关系

### 6.3 审批撤回

**场景**：

- 申请人发现信息错误
- 需要修改申请内容

**处理方式**：

- 审批中状态允许撤回
- 已审批节点需要重新审批
- 记录撤回历史

### 6.4 审批拒绝后的处理

**场景**：

- 任意节点拒绝

**处理方式**：

- 状态变为rejected
- 通知申请人拒绝原因
- 允许申请人修改后重新提交
- 保留历史审批记录

### 6.5 审批超时处理

**处理策略**：

1. **提醒阶段**（超时前2小时）
   - 发送提醒通知
   - 在审批人待办列表高亮显示

2. **警告阶段**（超时后）
   - 发送警告通知
   - 通知申请人审批延迟

3. **升级阶段**（超时后24小时）
   - 自动升级到上级审批人
   - 或通知系统管理员

4. **自动处理**（超时后72小时）
   - 根据配置自动通过/拒绝
   - 或标记为需要人工介入

## 7. 通知机制

### 7.1 通知时机

| 事件 | 通知对象 | 通知方式 |
|-----|---------|---------|
| 服务请求提交 | 第一个审批人 | 站内信、邮件、短信（可选） |
| 审批通过 | 下一个审批人、申请人 | 站内信、邮件 |
| 审批拒绝 | 申请人 | 站内信、邮件、短信 |
| 审批超时提醒 | 审批人 | 站内信、邮件 |
| 审批超时升级 | 上级审批人、管理员 | 站内信、邮件 |
| 全部审批通过 | 申请人、IT交付人员 | 站内信、邮件 |
| 资源交付完成 | 申请人 | 站内信、邮件 |

### 7.2 通知内容模板

**审批待办通知**：

```
标题：您有新的服务请求待审批
内容：
  申请人：{申请人姓名}
  服务类型：{服务目录名称}
  请求标题：{请求标题}
  申请原因：{申请原因}
  审批时限：{时限}
  链接：{审批链接}
```

**审批通过通知**：

```
标题：服务请求审批通过
内容：
  您的服务请求（#{请求ID}）已通过{审批节点}审批
  当前进度：{当前节点}/{总节点数}
  下一步：{下一步操作}
```

**审批拒绝通知**：

```
标题：服务请求审批被拒绝
内容：
  您的服务请求（#{请求ID}）在{审批节点}被拒绝
  拒绝原因：{审批意见}
  您可以修改后重新提交
```

## 8. 权限控制

### 8.1 审批权限矩阵

| 角色 | 查看申请 | 审批（主管） | 审批（IT） | 审批（安全） | 查看所有申请 |
|-----|---------|------------|-----------|------------|------------|
| 普通用户 | 自己的 | ❌ | ❌ | ❌ | ❌ |
| Manager | 自己的+部门的 | ✅（本部门） | ❌ | ❌ | 本部门的 |
| Agent/Technician | 所有 | ❌ | ✅ | ❌ | ✅ |
| Security | 所有 | ❌ | ❌ | ✅ | ✅ |
| Admin | 所有 | ✅ | ✅ | ✅ | ✅ |

### 8.2 权限校验规则

**审批权限校验**：

1. 检查用户角色是否匹配审批节点要求
2. 检查用户部门是否匹配（主管审批）
3. 检查是否为指定审批人
4. 检查审批记录状态是否为pending

**查看权限校验**：

1. 申请人可以查看自己的申请
2. 审批人可以查看待审批的申请
3. 部门主管可以查看本部门的申请
4. Admin可以查看所有申请

## 9. 数据模型设计

### 9.1 服务请求审批配置表（新增）

```go
type ServiceRequestApprovalConfig struct {
    ID              int
    CatalogID       int           // 关联服务目录
    WorkflowType    string        // standard/simplified/fast/conditional
    Nodes           JSON          // 审批节点配置
    Conditions      JSON          // 条件规则
    IsActive        bool
    TenantID        int
    CreatedAt       time.Time
    UpdatedAt       time.Time
}
```

### 9.2 审批记录表（已有，需扩展）

当前 `ServiceRequestApproval` 表已满足基本需求，建议扩展：

```go
// 建议新增字段
field.Int("timeout_hours").Comment("审批时限（小时）").Default(24)
field.Time("due_at").Comment("到期时间").Optional()
field.Bool("is_escalated").Comment("是否已升级").Default(false)
field.Int("delegated_to_id").Comment("转交审批人ID").Optional()
field.String("escalation_reason").Comment("升级原因").Optional()
```

### 9.3 审批历史表（新增，用于审计）

```go
type ServiceRequestApprovalHistory struct {
    ID                  int
    ServiceRequestID    int
    ApprovalID          int
    Action              string  // approve/reject/delegate/timeout/escalate
    ActorID             int
    ActorName           string
    Comment             string
    PreviousStatus      string
    NewStatus           string
    CreatedAt           time.Time
}
```

## 10. API设计

### 10.1 创建服务请求

```
POST /api/v1/service-requests
Request Body:
{
  "catalog_id": 1,
  "title": "申请云服务器",
  "reason": "业务扩展需要",
  "form_data": {...},
  "needs_public_ip": true,
  "data_classification": "confidential",
  ...
}
Response:
{
  "id": 123,
  "status": "submitted",
  "current_level": 1,
  "total_levels": 3,
  "approvals": [...]
}
```

### 10.2 获取待审批列表

```
GET /api/v1/service-requests/pending-approvals?page=1&size=10
Response:
{
  "requests": [...],
  "total": 50,
  "page": 1,
  "size": 10
}
```

### 10.3 审批操作

```
POST /api/v1/service-requests/{id}/approve
Request Body:
{
  "action": "approve",  // approve/reject
  "comment": "审批通过，同意申请"
}
Response:
{
  "id": 123,
  "status": "manager_approved",
  "current_level": 2,
  ...
}
```

### 10.4 转交审批

```
POST /api/v1/service-requests/{id}/delegate
Request Body:
{
  "delegated_to_id": 456,
  "comment": "转交给XXX审批"
}
```

### 10.5 获取审批流程配置

```
GET /api/v1/service-requests/approval-configs?catalog_id=1
Response:
{
  "workflow_type": "standard",
  "nodes": [...],
  "conditions": [...]
}
```

## 11. 前端交互设计

### 11.1 审批待办页面

- **列表视图**：显示待审批的服务请求
- **筛选功能**：按服务类型、申请人、提交时间筛选
- **快速操作**：批量审批、快速通过/拒绝
- **详情查看**：点击查看完整申请信息

### 11.2 审批操作页面

- **申请信息展示**：完整展示申请内容
- **审批历史**：显示已完成的审批节点
- **审批操作区**：
  - 通过/拒绝按钮
  - 审批意见输入框
  - 转交审批选项
- **审批进度条**：可视化显示审批进度

### 11.3 我的申请页面

- **申请列表**：显示用户提交的所有申请
- **状态筛选**：按状态筛选申请
- **进度跟踪**：实时显示审批进度
- **操作按钮**：查看详情、撤回（如允许）

## 12. 实施计划

### 12.1 第一阶段：基础功能（当前V0版本）

- ✅ 三段式审批流程（主管→IT→安全）
- ✅ 基础审批操作（通过/拒绝）
- ✅ 审批记录存储
- ✅ 基础权限控制

### 12.2 第二阶段：增强功能

- [ ] 审批流程配置化
- [ ] 条件审批支持
- [ ] 并行审批支持
- [ ] 审批超时处理
- [ ] 通知机制完善

### 12.3 第三阶段：高级功能

- [ ] 审批流程可视化设计器
- [ ] 智能审批人推荐
- [ ] 审批数据分析报表
- [ ] 移动端审批支持
- [ ] 审批流程模板库

## 13. 成功指标（KPI）

### 13.1 效率指标

- **平均审批时长**：目标 < 48小时
- **审批及时率**：目标 > 90%
- **超时审批率**：目标 < 5%

### 13.2 质量指标

- **审批通过率**：监控异常情况
- **审批拒绝率**：分析拒绝原因
- **重新提交率**：优化申请流程

### 13.3 用户体验指标

- **审批操作便捷性**：操作步骤 < 3步
- **通知及时性**：通知延迟 < 5分钟
- **用户满意度**：定期调研

## 14. 风险与应对

### 14.1 技术风险

- **风险**：审批流程复杂导致性能问题
- **应对**：异步处理、缓存优化、数据库索引优化

### 14.2 业务风险

- **风险**：审批人不在导致流程阻塞
- **应对**：代理审批、自动升级、超时处理

### 14.3 合规风险

- **风险**：审批记录不完整影响审计
- **应对**：完整记录审批历史、不可篡改、定期备份

---

## 附录：审批流程示例

### 示例1：标准云服务器申请

```
1. 用户提交申请（包含公网IP需求）
2. 系统判断需要三段审批
3. 创建3个审批记录（manager/it/security）
4. 通知部门主管审批
5. 主管审批通过 → 状态变为manager_approved
6. 通知IT人员审批
7. IT审批通过 → 状态变为it_approved
8. 通知安全人员审批（因为需要公网IP）
9. 安全审批通过 → 状态变为security_approved
10. 所有审批通过 → 状态变为approved
11. 触发资源交付流程
```

### 示例2：简化内部服务申请

```
1. 用户提交申请（内部服务，无公网IP）
2. 系统判断需要两段审批（manager/it）
3. 创建2个审批记录
4. 通知部门主管审批
5. 主管审批通过
6. 通知IT人员审批
7. IT审批通过 → 状态变为approved
8. 触发资源交付流程
```

### 示例3：紧急申请

```
1. 用户提交紧急申请
2. 系统缩短审批时限（24h → 6h）
3. 立即通知所有审批人（邮件+短信）
4. 审批人收到高优先级提醒
5. 超时后自动升级到上级
```

---

**文档版本**：V1.0  
**创建日期**：2025-12-17  
**最后更新**：2025-12-17  
**维护人**：产品团队

# 模块开发深入分析与完善方案（基于 module-development-status.md）

- 日期: 2025-12-07
- 范围: 后端（Go + Ent + Gin）与前端（Next.js + TS + React）
- 目标: 针对各模块当前状态与问题，制定可执行的完善方案与验收标准，优先解决 P0 阻塞与高影响问题，提升测试覆盖与一致性

## 全局优先级
- P0 阻塞
  - 修复 BPMN 适配器 API 不匹配（编译失败阻断工作流模块）
  - 统一后端测试 Schema（Ent 方法与 DTO 字段不一致导致测试失败）
  - 前端 API 调用规范化（组件内直接 `fetch/localStorage` → 统一 API 层 + http-client）
- P1 高优先级
  - DTO 字段对齐与控制器构造签名统一
  - 测试路径与别名修复（`@`），页面级 Provider 测试包装统一
- P2 中优先级
  - CSS Modules 迁移至 Tailwind
  - 测试覆盖率提升（目标 ≥ 80%）
- P3 低优先级
  - 清理 `console.log` 调试与 React 版本升级评估

## 跨模块通用整改
- 后端测试与 DTO 对齐
  - 将 `ent.UserCreate.SetStatus(...)`、`Tenant.SetActive(...)` 等替换为现有 Schema 的 `SetActive(true)` 或 `SetStatus("active")`
  - 补齐 DTO 字段或调整测试引用：`RefreshTokenResponse.RefreshToken`、`UserInfo.DisplayName/Phone`、`SearchUsersRequest.Page/Department`
  - 统一控制器构造签名（注入 `*zap.SugaredLogger`）并同步更新测试
  - 验收: `go test ./...` 编译通过；核心服务测试通过率 ≥ 80%
- 前端 API 层规范化
  - 组件中禁用直接 `fetch/localStorage`，统一经 `http-client` 与模块 API（如 `IncidentAPI`/`TicketApi`）
  - 验收: 组件代码检查无直接 `fetch/localStorage`；关键页面通过 API 层调用（网络面板可见）
- 页面级测试包装
  - 为 Dashboard/Tickets 等页面统一注入 Provider（`QueryClientProvider`）、Router 与 AntD `App` 上下文；拆分页面测试为组件测试
  - 验收: 页面用例不再报 `Invalid hook call`；RTL 用例稳定运行

## 模块完善方案
- 认证与账户（完成度: 后端 90% / 前端 85% / 覆盖 60%）
  - 修复后端测试 Schema：`SetActive(true)` 替代 `SetStatus(...)`；DTO 字段补齐或测试调整
  - RBAC 权限场景测试：越权拦截、租户切换影响
  - E2E: 登录成功/失败提示与焦点返回、刷新令牌、租户切换后列表与头部参数一致
  - 验收: 后端测试通过率 ≥ 85%；E2E 用例稳定；网络面板显示规范头部
- 工单管理（95%/90%/70%）
  - 前端创建页: 修复分类/优先级选择控件（提供数据源或控件修复）；完成创建成功与附件上传
  - 统一筛选/分页与 Loading/Empty/Error 模板（复用于 Tickets/Incidents/Problems/Changes）
  - E2E: 列表筛选与分页、详情编辑保存刷新、`POST /api/v1/tickets/:id/attachments` 记录
  - 验收: 创建成功回显与附件上传成功；列表筛选分页与 URL 同步；模板统一落地
- 事件管理（85%/80%/50%）
  - 完成 API 层统一（已改造 `IncidentManagement.tsx`）；补充状态/来源筛选；实现后端 CloseIncident
  - E2E: 搜索与筛选一致性；统计卡片与列表一致；网络面板记录 `listIncidents` 与 `stats`
  - 验收: `CloseIncident` 接口可用；前端筛选联动与统计一致；API 层请求可见
- 问题管理（75%/75%/40%）
  - 完善调查步骤与根因分析流程；与工单根因分析整合
  - 测试: 补充后端表驱动测试与前端 RTL 测试（步骤 CRUD、报告生成）
  - 验收: 步骤管理与报告生成稳定；E2E 用例通过
- 变更管理（70%/70%/30%）
  - 与 BPMN 审批/工作流集成完善；审批记录管理与历史追踪
  - 测试: 后端审批流程测试；前端变更创建与审批链路测试
  - 验收: 审批链路稳定；E2E 用例通过
- SLA 管理（90%/85%/60%）
  - 补充预警规则单元测试与监控数据实时性验证
  - E2E: 定义 CRUD 与列表刷新、违规状态更新、预警规则与历史
  - 验收: 预警规则触发与历史记录正确；监控数据更新可见
- CMDB（80%/75%/40%）
  - 增强关系图与拓扑视图性能（虚拟化 + 分层加载）；大数据优化
  - 测试: 关系图功能测试；性能用例（大数据集）
  - 验收: 大数据场景交互流畅；关系图功能稳定
- 知识库（75%/70%/30%）
  - 实现版本管理与协作功能；完善与工单集成（推荐/关联）
  - 测试: 后端版本管理测试；前端 CRUD 与关联推荐用例
  - 验收: 版本历史可见；协作冲突处理；关联推荐正常
- 服务目录（70%/70%/30%）
  - 完善动态表单生成与验证；与审批流程集成
  - 测试: 后端服务请求流程测试；前端表单校验与撤回/重试用例
  - 验收: 服务请求链路稳定、表单验证与重试有效
- 工作流/BPMN（60%/60%/20%）
  - 修复适配器: `bpmn_engine.New(name string)` 参数对齐；替换未导出方法；编译通过
  - 测试: 后端工作流部署与任务操作；前端设计器基本交互
  - 验收: `go test` 编译通过；工作流部署与实例操作成功；基本 E2E 用例通过
- 报表分析（80%/85%/50%）
  - 导出功能增强（CSV/PNG），数据准确性验证
  - 测试: 导出用例与图表数据校验
  - 验收: 导出成功；图表与指标一致
- AI 功能（85%/75%/40%）
  - 补充 Embedding 管线测试、工具执行与审批流程测试、AI 反馈机制优化
  - 验收: Embedding 成功率与性能达标；工具执行权限与审批闭环；反馈记录稳定
- 用户/组织管理（85%/80%/50%）
  - 修复控制器测试签名；补充 RBAC 权限测试与树形结构展示测试
  - 验收: 构造签名统一；权限用例通过；树形展示与成员管理稳定
- Dashboard（90%/90%/60%）
  - 统一页面测试包装；图表数据准确性验证用例
  - 验收: 页面级测试稳定；图表数据对齐后端指标

## 测试与验收体系
- 后端
  - 使用 `enttest.NewClient()` 构造测试数据；表驱动测试覆盖错误路径
  - 目标: 模块核心服务测试覆盖率 ≥ 80%
- 前端
  - RTL 组件交互测试 + Playwright E2E 测试（登录/租户切换、列表筛选/分页、创建与上传、报表导出等）
  - 目标: 关键页面与组件测试覆盖率 ≥ 80%；E2E 用例稳定
- 数据库与性能
  - 安装 `pg_stat_statements` 和 `hypopg`（DBA 操作）后进行慢查询与索引评估；清理重复/覆盖索引
  - 验收: 报表与列表性能稳定；索引冗余减少

## 立即行动清单（两周内）
1. 修复 BPMN 适配器编译问题（P0）
2. 统一后端测试 Schema 与 DTO 字段（认证/工单/事件）（P0）
3. 前端 API 层规范化（迁移组件内直接调用）（P0）
4. 完成工单创建与附件上传端到端用例（P1）
5. 仪表盘与报表页面级测试包装与数据准确性校验（P1）
6. 事件状态/来源筛选与 `listIncidents`/`stats` 请求记录（P1）

## 交付与追踪
- 报告与记录
  - `test/system-testing-report.md`：每次执行后更新进展与通过率
  - `test/browser-e2e-run-results.md`：追加 PASS/FAIL 与截图/请求摘要
  - `test/e2e-regression-postgres-mcp.md`：数据库健康与索引优化建议更新
- 指标
  - 编译状态：`go test ./...` 通过
  - 测试覆盖率：后端/前端 ≥ 80%
  - E2E 用例：核心链路全部 PASS（认证、工单、事件、SLA、报表、管理台）


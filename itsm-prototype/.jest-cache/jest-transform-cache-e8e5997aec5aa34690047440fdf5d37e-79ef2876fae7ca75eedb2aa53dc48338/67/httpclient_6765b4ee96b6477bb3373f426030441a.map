{"version":3,"sources":["/Users/heidsoft/Downloads/research/itsm/itsm-prototype/src/lib/api/http-client.ts"],"sourcesContent":["import { API_BASE_URL } from '@/app/lib/api-config';\nimport { security } from '@/lib/security';\n\n// Request configuration interface\ninterface RequestConfig {\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\n  headers?: Record<string, string>;\n  body?: string;\n  timeout?: number;\n}\n\n// API response interface\ninterface ApiResponse<T> {\n  code: number;\n  message: string;\n  data: T;\n}\n\nclass HttpClient {\n  private baseURL: string;\n  private token: string | null = null;\n  private tenantId: number | null = null;\n  private tenantCode: string | null = null;\n  private readonly timeout: number;\n\n  constructor(baseURL: string = API_BASE_URL) {\n    this.baseURL = process.env.NEXT_PUBLIC_API_URL || baseURL;\n    this.timeout = parseInt(process.env.NEXT_PUBLIC_API_TIMEOUT || '30000');\n    // Get token and tenant ID from localStorage\n    if (typeof window !== 'undefined') {\n      this.token = localStorage.getItem('access_token'); // Changed to access_token\n      const storedTenantId = localStorage.getItem('current_tenant_id');\n      this.tenantId = storedTenantId ? parseInt(storedTenantId) : null;\n      this.tenantCode = localStorage.getItem('current_tenant_code') || null;\n    }\n  }\n\n  setToken(token: string) {\n    this.token = token;\n    if (typeof window !== 'undefined') {\n      localStorage.setItem('access_token', token); // Changed to access_token\n      // 同步更新 Cookie，有效期 15 分钟\n      document.cookie = `auth-token=${token}; path=/; max-age=900; SameSite=Lax`;\n    }\n  }\n\n  clearToken() {\n    this.token = null;\n    if (typeof window !== 'undefined') {\n      localStorage.removeItem('access_token'); // Changed to access_token\n      // 清除 Cookie\n      document.cookie = 'auth-token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n      document.cookie = 'refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n    }\n  }\n\n  setTenantId(tenantId: number | null) {\n    this.tenantId = tenantId;\n    if (typeof window !== 'undefined') {\n      if (tenantId) {\n        localStorage.setItem('current_tenant_id', tenantId.toString());\n      } else {\n        localStorage.removeItem('current_tenant_id');\n      }\n    }\n  }\n\n  setTenantCode(code: string | null) {\n    this.tenantCode = code;\n    console.log('HttpClient.setTenantCode:', code);\n    if (typeof window !== 'undefined') {\n      if (code) {\n        localStorage.setItem('current_tenant_code', code);\n      } else {\n        localStorage.removeItem('current_tenant_code');\n      }\n    }\n  }\n\n  // Get tenant code\n  getTenantCode(): string | null {\n    return this.tenantCode;\n  }\n\n  getTenantId(): number | null {\n    return this.tenantId;\n  }\n\n  getAuthToken(): string | null {\n    return this.token;\n  }\n\n  private getHeaders(): Record<string, string> {\n    // Set secure request headers\n    const csrfToken = security.csrf.getTokenFromMeta();\n    const headers: Record<string, string> = {\n      ...security.network.getSecureHeaders(csrfToken || undefined),\n    };\n\n    // Dynamically get the latest token and tenantId\n    const currentToken = typeof window !== 'undefined' ? localStorage.getItem('access_token') : this.token;\n    const currentTenantId = typeof window !== 'undefined' ? localStorage.getItem('current_tenant_id') : this.tenantId;\n\n    if (currentToken) {\n      headers['Authorization'] = `Bearer ${currentToken}`;\n    }\n\n    if (currentTenantId) {\n      headers['X-Tenant-ID'] = currentTenantId.toString();\n    }\n    const currentTenantCode = typeof window !== 'undefined' ? localStorage.getItem('current_tenant_code') : this.tenantCode;\n    if (currentTenantCode) {\n      headers['X-Tenant-Code'] = currentTenantCode;\n    }\n\n    return headers;\n  }\n\n  // Independent token refresh method to avoid circular dependencies\n  private async refreshTokenInternal(): Promise<boolean> {\n    const refreshToken = typeof window !== 'undefined' ? localStorage.getItem('refresh_token') : null;\n    if (!refreshToken) {\n      return false;\n    }\n\n    try {\n      const response = await fetch(`${this.baseURL}/api/v1/refresh-token`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          refresh_token: refreshToken,\n        }),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        if (data.code === 0) {\n          // Update access token\n          this.setToken(data.data.access_token);\n          // Also update instance variable\n          this.token = data.data.access_token;\n          return true;\n        }\n      }\n      return false;\n    } catch (error) {\n      console.error('Token refresh failed:', error);\n      return false;\n    }\n  }\n\n  // Request method using fetch API\n  private async request<T>(endpoint: string, config: RequestConfig): Promise<T> {\n    const url = `${this.baseURL}${endpoint}`;\n    const headers = this.getHeaders();\n    const requestConfig: RequestInit = {\n      method: config.method,\n      headers: {\n        ...headers,\n        ...config.headers,\n      },\n      body: config.body,\n    };\n\n    console.log('HTTP Client Request:', {\n      url,\n      method: config.method,\n      headers,\n      body: config.body\n    });\n\n    // 在开发模式下，如果后端服务不可用，使用模拟数据\n    if (process.env.NODE_ENV === 'development' && this.baseURL.includes('localhost')) {\n      console.warn('开发模式：正在连接到后端服务，如果后端服务未运行，将显示错误');\n    }\n\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), this.timeout);\n      \n      const response = await fetch(url, {\n        ...requestConfig,\n        signal: controller.signal,\n      });\n      \n      clearTimeout(timeoutId);\n      \n      console.log('HTTP Client Response:', {\n        status: response.status,\n        statusText: response.statusText,\n        headers: response.headers ? Object.fromEntries(response.headers.entries()) : {}\n      });\n      \n      // If 401 error, try to refresh token\n      if (response.status === 401) {\n        const refreshSuccess = await this.refreshTokenInternal();\n        if (refreshSuccess) {\n          // Retry original request\n          const retryConfig: RequestInit = {\n            ...requestConfig,\n            headers: {\n              ...this.getHeaders(),\n              ...config.headers,\n            },\n          };\n          const retryResponse = await fetch(url, retryConfig);\n          if (!retryResponse.ok) {\n            const rid = retryResponse.headers.get('X-Request-Id') || '';\n            const suffix = rid ? ` [RID: ${rid}]` : '';\n            throw new Error(`HTTP error! status: ${retryResponse.status}${suffix}`);\n          }\n          const retryData = await retryResponse.json() as ApiResponse<T>;\n          console.log('HTTP Client Retry Response Data:', retryData);\n          \n          // Check response code\n          if (retryData.code !== 0) {\n            const rid = retryResponse.headers.get('X-Request-Id') || '';\n            const suffix = rid ? ` [RID: ${rid}]` : '';\n            throw new Error((retryData.message || 'Request failed') + suffix);\n          }\n          \n          return retryData.data;\n        } else {\n          // Refresh failed, clear token and redirect to login\n          this.clearToken();\n          if (typeof window !== 'undefined') {\n            localStorage.removeItem('refresh_token');\n            window.location.href = '/login';\n          }\n          throw new Error('Authentication failed');\n        }\n      }\n\n      if (!response.ok) {\n        const rid = response.headers.get('X-Request-Id') || '';\n        const suffix = rid ? ` [RID: ${rid}]` : '';\n        throw new Error(`HTTP error! status: ${response.status}${suffix}`);\n      }\n\n      const responseData = await response.json() as ApiResponse<T>;\n      console.log('HTTP Client Raw Response Data:', responseData);\n      \n      // Check response code\n      if (responseData.code !== 0) {\n        const rid = (response.headers && response.headers.get('X-Request-Id')) || '';\n        const suffix = rid ? ` [RID: ${rid}]` : '';\n        throw new Error((responseData.message || 'Request failed') + suffix);\n      }\n      \n      return responseData.data;\n    } catch (error: unknown) {\n      console.error('Request failed:', error);\n      if (error instanceof Error) {\n        if (error.name === 'AbortError') {\n          throw new Error('请求超时，请稍后重试');\n        }\n        if (error.message.includes('fetch')) {\n          throw new Error('无法连接到服务器，请检查网络连接和后端服务是否运行');\n        }\n        throw error;\n      }\n      throw new Error('未知错误发生');\n    }\n  }\n\n  async get<T>(endpoint: string, params?: Record<string, unknown>): Promise<T> {\n    let url = endpoint;\n    if (params) {\n      const searchParams = new URLSearchParams();\n      Object.entries(params).forEach(([key, value]) => {\n        if (value !== undefined && value !== null) {\n          searchParams.append(key, String(value));\n        }\n      });\n      url += `?${searchParams.toString()}`;\n    }\n    \n    return this.request<T>(url, {\n      method: 'GET',\n    });\n  }\n\n  async post<T>(endpoint: string, data?: unknown, config?: { onUploadProgress?: (progress: number) => void }): Promise<T> {\n    // 如果是 FormData，直接传递，不进行 JSON.stringify\n    if (data instanceof FormData) {\n      const url = `${this.baseURL}${endpoint}`;\n      const headers = this.getHeaders();\n      // FormData 上传时，不要设置 Content-Type，让浏览器自动设置（包含 boundary）\n      delete headers['Content-Type'];\n      \n      // 如果支持上传进度，使用 XMLHttpRequest\n      if (config?.onUploadProgress) {\n        return new Promise<T>((resolve, reject) => {\n          const xhr = new XMLHttpRequest();\n          \n          xhr.upload.addEventListener('progress', (event) => {\n            if (event.lengthComputable && config.onUploadProgress) {\n              const progress = Math.round((event.loaded * 100) / event.total);\n              config.onUploadProgress(progress);\n            }\n          });\n          \n          xhr.addEventListener('load', () => {\n            if (xhr.status >= 200 && xhr.status < 300) {\n              try {\n                const response = JSON.parse(xhr.responseText) as ApiResponse<T>;\n                if (response.code === 0) {\n                  resolve(response.data);\n                } else {\n                  reject(new Error(response.message || 'Request failed'));\n                }\n              } catch (error) {\n                reject(new Error('Failed to parse response'));\n              }\n            } else {\n              reject(new Error(`HTTP error! status: ${xhr.status}`));\n            }\n          });\n          \n          xhr.addEventListener('error', () => {\n            reject(new Error('Network error'));\n          });\n          \n          xhr.open('POST', url);\n          Object.entries(headers).forEach(([key, value]) => {\n            if (key !== 'Content-Type') {\n              xhr.setRequestHeader(key, value);\n            }\n          });\n          xhr.send(data);\n        });\n      }\n      \n      // 不支持进度时，使用 fetch\n      const response = await fetch(url, {\n        method: 'POST',\n        headers,\n        body: data,\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      \n      const responseData = await response.json() as ApiResponse<T>;\n      if (responseData.code !== 0) {\n        throw new Error(responseData.message || 'Request failed');\n      }\n      \n      return responseData.data;\n    }\n    \n    return this.request<T>(endpoint, {\n      method: 'POST',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async put<T>(endpoint: string, data?: unknown): Promise<T> {\n    return this.request<T>(endpoint, {\n      method: 'PUT',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async patch<T>(endpoint: string, data?: unknown): Promise<T> {\n    return this.request<T>(endpoint, {\n      method: 'PATCH',\n      body: data ? JSON.stringify(data) : undefined,\n    });\n  }\n\n  async delete<T>(endpoint: string): Promise<T> {\n    return this.request<T>(endpoint, {\n      method: 'DELETE',\n    });\n  }\n\n  // 分页查询方法\n  async getPaginated<T>(\n    endpoint: string, \n    params?: {\n      page?: number;\n      pageSize?: number;\n      sortBy?: string;\n      sortOrder?: 'asc' | 'desc';\n      filters?: Record<string, any>;\n    }\n  ): Promise<{\n    data: T[];\n    total: number;\n    page: number;\n    pageSize: number;\n    totalPages: number;\n  }> {\n    const queryParams = new URLSearchParams();\n    if (params) {\n      Object.entries(params).forEach(([key, value]) => {\n        if (value !== undefined && value !== null) {\n          if (key === 'filters' && typeof value === 'object') {\n            Object.entries(value).forEach(([filterKey, filterValue]) => {\n              if (filterValue !== undefined && filterValue !== null) {\n                queryParams.append(`filters[${filterKey}]`, String(filterValue));\n              }\n            });\n          } else {\n            queryParams.append(key, String(value));\n          }\n        }\n      });\n    }\n    \n    const url = queryParams.toString() \n      ? `${endpoint}?${queryParams.toString()}` \n      : endpoint;\n      \n    return this.get(url);\n  }\n\n  // 批量操作方法\n  async batchOperation<T>(\n    endpoint: string, \n    operation: string, \n    data: any[]\n  ): Promise<T[]> {\n    return this.post<T[]>(endpoint, {\n      operation,\n      data\n    });\n  }\n\n  // 文件上传方法\n  async uploadFile(\n    endpoint: string, \n    file: File, \n    onProgress?: (progress: number) => void\n  ): Promise<{\n    url: string;\n    filename: string;\n    size: number;\n  }> {\n    const formData = new FormData();\n    formData.append('file', file);\n\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest();\n      \n      xhr.upload.addEventListener('progress', (event) => {\n        if (event.lengthComputable && onProgress) {\n          const progress = (event.loaded / event.total) * 100;\n          onProgress(progress);\n        }\n      });\n\n      xhr.addEventListener('load', () => {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          try {\n            const response = JSON.parse(xhr.responseText);\n            resolve(response);\n          } catch (error) {\n            reject(new Error('Invalid response format'));\n          }\n        } else {\n          reject(new Error(`Upload failed: ${xhr.statusText}`));\n        }\n      });\n\n      xhr.addEventListener('error', () => {\n        reject(new Error('Upload failed'));\n      });\n\n      xhr.open('POST', endpoint);\n      \n      // 添加认证头\n      const token = this.getAuthToken();\n      if (token) {\n        xhr.setRequestHeader('Authorization', `Bearer ${token}`);\n      }\n\n      xhr.send(formData);\n    });\n  }\n}\n\nexport const httpClient = new HttpClient();\nexport default HttpClient;"],"names":["httpClient","HttpClient","constructor","baseURL","API_BASE_URL","token","tenantId","tenantCode","process","env","NEXT_PUBLIC_API_URL","timeout","parseInt","NEXT_PUBLIC_API_TIMEOUT","window","localStorage","getItem","storedTenantId","setToken","setItem","document","cookie","clearToken","removeItem","setTenantId","toString","setTenantCode","code","console","log","getTenantCode","getTenantId","getAuthToken","getHeaders","csrfToken","security","csrf","getTokenFromMeta","headers","network","getSecureHeaders","undefined","currentToken","currentTenantId","currentTenantCode","refreshTokenInternal","refreshToken","response","fetch","method","body","JSON","stringify","refresh_token","ok","data","json","access_token","error","request","endpoint","config","url","requestConfig","NODE_ENV","includes","warn","controller","AbortController","timeoutId","setTimeout","abort","signal","clearTimeout","status","statusText","Object","fromEntries","entries","refreshSuccess","retryConfig","retryResponse","rid","get","suffix","Error","retryData","message","location","href","responseData","name","params","searchParams","URLSearchParams","forEach","key","value","append","String","post","FormData","onUploadProgress","Promise","resolve","reject","xhr","XMLHttpRequest","upload","addEventListener","event","lengthComputable","progress","Math","round","loaded","total","parse","responseText","open","setRequestHeader","send","put","patch","delete","getPaginated","queryParams","filterKey","filterValue","batchOperation","operation","uploadFile","file","onProgress","formData"],"mappings":"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"}